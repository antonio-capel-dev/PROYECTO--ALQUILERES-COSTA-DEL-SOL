---
import SeoHead from "../components/SeoHead.astro";
import Boton from "../components/ui/Boton.astro";
import Icon from "../components/ui/Icon.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { NAV_ITEMS, FOOTER_LINKS } from "../config/navigation";
import "../styles/global.css";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const {
  titulo,
  descripcion,
  imagen,
  urlPrevia,
  urlSiguiente,
  faq,
  breadcrumbs,
  alternateLinks,
} = Astro.props;

// Helper para rutas localizadas
const getPath = (href: string) => {
  if (lang === "es") return href;
  return `/${lang}${href}`;
};

// Base path sin prefijo de idioma (para el selector de idioma)
const pathname = Astro.url.pathname;
const basePath =
  lang === "es" ? pathname : pathname.replace(new RegExp(`^/${lang}`), "") || "/";

const getLangPath = (targetLang: "es" | "en" | "fr") =>
  targetLang === "es"
    ? basePath
    : `/${targetLang}${basePath === "/" ? "" : basePath}`;
---

<!doctype html>
<html lang={lang}>
  <head>
    <SeoHead
      titulo={titulo}
      descripcion={descripcion}
      imagen={imagen}
      urlPrevia={urlPrevia}
      urlSiguiente={urlSiguiente}
      faq={faq}
      breadcrumbs={breadcrumbs}
      alternateLinks={alternateLinks}
    />
    <!-- Preload critical fonts for LCP -->
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      as="style"
    />
    <slot name="preload" />
    <slot name="head" />
  </head>
  <body
    class="bg-fondo-claro flex flex-col min-h-screen selection:bg-secundario/10 selection:text-secundario"
  >
    <!-- ── NAVEGACIÓN ──────────────────────────────────────────────── -->
    <nav
      class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-superficie"
    >
      <div class="contenedor-fluido">
        <div class="flex justify-between items-center h-20">

          <!-- Logo -->
          <div class="shrink-0 flex items-center gap-2">
            <Icon name="sun" class="w-7 h-7 text-secundario" aria-hidden="true" />
            <a
              href={getPath("/")}
              class="text-2xl font-bold bg-linear-to-r from-secundario to-acento bg-clip-text text-transparent hover:opacity-80 transition"
            >
              Costa del Sol
            </a>
          </div>

          <!-- ── DESKTOP: Nav links + idioma + CTA ── -->
          <div class="hidden md:flex items-center space-x-8">
            {
              NAV_ITEMS.map((item) => (
                <a
                  href={getPath(item.href)}
                  class="text-texto-secundario hover:text-secundario font-medium transition duration-150"
                >
                  {t(item.key)}
                </a>
              ))
            }

            <!-- Selector de Idioma — Desktop -->
            <nav
              aria-label="Selector de idioma"
              class="flex items-center gap-2 text-sm font-medium border-l border-superficie pl-6 ml-2"
            >
              <Icon name="globe" class="w-4 h-4 text-texto-secundario" aria-hidden="true" />
              <a
                href={getLangPath("es")}
                hreflang="es"
                lang="es"
                aria-current={lang === "es" ? "true" : undefined}
                class={`transition ${lang === "es" ? "text-secundario font-bold" : "text-texto-secundario hover:text-secundario"}`}
              >ES</a>
              <span class="text-fondo-claro/60" aria-hidden="true">|</span>
              <a
                href={getLangPath("en")}
                hreflang="en"
                lang="en"
                aria-current={lang === "en" ? "true" : undefined}
                class={`transition ${lang === "en" ? "text-secundario font-bold" : "text-texto-secundario hover:text-secundario"}`}
              >EN</a>
              <span class="text-fondo-claro/60" aria-hidden="true">|</span>
              <a
                href={getLangPath("fr")}
                hreflang="fr"
                lang="fr"
                aria-current={lang === "fr" ? "true" : undefined}
                class={`transition ${lang === "fr" ? "text-secundario font-bold" : "text-texto-secundario hover:text-secundario"}`}
              >FR</a>
            </nav>

            <Boton
              href={getPath("/contacto")}
              variante="secundario"
              tamano="peque"
            >
              {t("nav.reserve")}
            </Boton>
          </div>

          <!-- ── MÓVIL: Botón hamburguesa ── -->
          <button
            id="menu-btn"
            type="button"
            aria-label="Abrir menú"
            aria-expanded="false"
            aria-controls="menu-movil"
            class="md:hidden inline-flex items-center justify-center p-2 rounded-lg text-texto-secundario hover:text-secundario hover:bg-superficie transition"
          >
            <span id="icono-menu" aria-hidden="true">
              <Icon name="menu" class="w-6 h-6" />
            </span>
            <span id="icono-cerrar" class="hidden" aria-hidden="true">
              <Icon name="x" class="w-6 h-6" />
            </span>
          </button>

        </div>
      </div>

      <!-- ── PANEL MENÚ MÓVIL ── -->
      <div
        id="menu-movil"
        class="hidden absolute top-full left-0 right-0 bg-white border-b border-superficie shadow-xl"
        role="dialog"
        aria-label="Menú de navegación"
      >
        <div class="contenedor-fluido py-4">

          <!-- Links de navegación -->
          <nav>
            <ul class="flex flex-col space-y-1">
              {
                NAV_ITEMS.map((item) => (
                  <li>
                    <a
                      href={getPath(item.href)}
                      class="menu-link flex items-center px-4 py-3 text-primario hover:bg-secundario/5 hover:text-secundario rounded-xl font-medium transition"
                    >
                      {t(item.key)}
                    </a>
                  </li>
                ))
              }
            </ul>
          </nav>

          <!-- Selector de idioma móvil -->
          <div class="flex items-center gap-3 px-4 py-3 mt-2 border-t border-superficie">
            <Icon name="globe" class="w-4 h-4 text-texto-secundario" aria-hidden="true" />
            <nav aria-label="Selector de idioma" class="flex items-center gap-3 text-sm font-semibold">
              <a
                href={getLangPath("es")}
                hreflang="es"
                lang="es"
                aria-current={lang === "es" ? "true" : undefined}
                class={`menu-link transition ${lang === "es" ? "text-secundario" : "text-texto-secundario hover:text-secundario"}`}
              >ES</a>
              <span class="text-fondo-claro/60" aria-hidden="true">|</span>
              <a
                href={getLangPath("en")}
                hreflang="en"
                lang="en"
                aria-current={lang === "en" ? "true" : undefined}
                class={`menu-link transition ${lang === "en" ? "text-secundario" : "text-texto-secundario hover:text-secundario"}`}
              >EN</a>
              <span class="text-fondo-claro/60" aria-hidden="true">|</span>
              <a
                href={getLangPath("fr")}
                hreflang="fr"
                lang="fr"
                aria-current={lang === "fr" ? "true" : undefined}
                class={`menu-link transition ${lang === "fr" ? "text-secundario" : "text-texto-secundario hover:text-secundario"}`}
              >FR</a>
            </nav>
          </div>

          <!-- CTA móvil -->
          <div class="px-4 pt-2 pb-4 border-t border-superficie mt-2">
            <Boton href={getPath("/contacto")} variante="primario" clase="w-full menu-link">
              {t("nav.reserve")}
            </Boton>
          </div>

        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow">
      <slot />
    </main>

    <!-- ── FOOTER ──────────────────────────────────────────────────── -->
    <footer class="bg-primario text-fondo-claro/80 border-t border-primario">
      <div class="contenedor-fluido py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">

          <!-- Columna marca -->
          <div class="col-span-1">
            <Icon name="sun" class="w-8 h-8 text-secundario mb-4" aria-hidden="true" />
            <p class="text-sm leading-relaxed text-texto-secundario">
              {t("hero.desc")}
            </p>
          </div>

          <!-- Columna empresa -->
          <div>
            <h3 class="text-xl font-bold text-white mb-4">
              {t("footer.company")}
            </h3>
            <ul class="space-y-2 text-fondo-claro/80">
              {
                FOOTER_LINKS.company.map((link) => (
                  <li>
                    <a
                      href={getPath(link.href)}
                      class="hover:text-acento transition"
                    >
                      {t(link.key as any)}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>

          <!-- Columna destinos -->
          <div>
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
              {t("destinations.title")}
              <Icon name="compass" class="w-4 h-4 text-texto-secundario" aria-hidden="true" />
            </h3>
            <ul class="space-y-2 text-fondo-claro/80">
              {
                FOOTER_LINKS.destinations.map((dest) => (
                  <li>
                    <a
                      href={getPath(dest.href)}
                      class="hover:text-acento decoration-acento underline-offset-4 hover:underline transition"
                    >
                      {dest.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>

          <!-- Columna contacto -->
          <div>
            <h3 class="text-xl font-bold text-white mb-4">
              {t("footer.contact")}
            </h3>
            <p class="text-fondo-claro/80 flex items-center gap-2 mb-1">
              <Icon name="mail" class="w-4 h-4 shrink-0" aria-hidden="true" />
              info@costadelsol.com
            </p>
            <p class="text-fondo-claro/80 flex items-center gap-2 mb-4">
              <Icon name="phone" class="w-4 h-4 shrink-0" aria-hidden="true" />
              +34 612 345 678
            </p>
            <p class="text-sm text-texto-secundario italic flex items-start gap-2">
              <Icon name="map-pin" class="w-4 h-4 shrink-0 mt-0.5" aria-hidden="true" />
              <span>
                Calle Larios 1, 29005 Málaga, España.<br />
                Oficina registrada: B-12345678
              </span>
            </p>
          </div>

        </div>
      </div>
      <div
        class="border-t border-primario mt-8 py-8 text-center text-texto-secundario"
      >
        <p>
          &copy; {new Date().getFullYear()} Costa del Sol. {t("footer.rights")}
        </p>
      </div>
    </footer>

    <!-- ── SCRIPT MENÚ MÓVIL (inline, sin dependencias externas) ── -->
    <script is:inline>
      (function () {
        var btn = document.getElementById("menu-btn");
        var menu = document.getElementById("menu-movil");
        var iconMenu = document.getElementById("icono-menu");
        var iconCerrar = document.getElementById("icono-cerrar");

        if (!btn || !menu) return;

        function abrirMenu() {
          menu.classList.remove("hidden");
          btn.setAttribute("aria-expanded", "true");
          iconMenu.classList.add("hidden");
          iconCerrar.classList.remove("hidden");
        }

        function cerrarMenu() {
          menu.classList.add("hidden");
          btn.setAttribute("aria-expanded", "false");
          iconMenu.classList.remove("hidden");
          iconCerrar.classList.add("hidden");
        }

        btn.addEventListener("click", function () {
          var estaAbierto = !menu.classList.contains("hidden");
          estaAbierto ? cerrarMenu() : abrirMenu();
        });

        // Cerrar al hacer click en cualquier enlace del menú
        menu.querySelectorAll(".menu-link").forEach(function (link) {
          link.addEventListener("click", cerrarMenu);
        });

        // Cerrar con tecla Escape (accesibilidad)
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") cerrarMenu();
        });
      })();
    </script>
  </body>
</html>
