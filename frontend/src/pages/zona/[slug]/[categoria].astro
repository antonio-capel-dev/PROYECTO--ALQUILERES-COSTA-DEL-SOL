---
import Layout from "../../../layouts/Layout.astro";
import FichaAlquiler from "../../../components/FichaAlquiler.astro";
import HeroZona from "../../../components/HeroZona.astro";
import Boton from "../../../components/ui/Boton.astro";
import Breadcrumbs from "../../../components/ui/Breadcrumbs.astro";
import { normalizarRentalStrapi } from "../../../utils/normalizadores";

// ── 1. GET STATIC PATHS (Combinatoria Zona * Categoria) ─────────────────────
export async function getStaticPaths() {
  const categories = [
    { slug: "lujo", nombre: "Lujo", seo: "Villas de Lujo y Áticos Premium" },
    {
      slug: "familias",
      nombre: "Familias",
      seo: "Apartamentos Familiares y Seguros",
    },
    { slug: "playa", nombre: "Playa", seo: "En Primera Línea de Playa" },
    { slug: "golf", nombre: "Golf", seo: "Cerca de Campos de Golf" },
    {
      slug: "casco-antiguo",
      nombre: "Casco Antiguo",
      seo: "En el Centro Histórico",
    },
  ];

  const zones = [
    { slug: "marbella", nombre: "Marbella" },
    { slug: "malaga", nombre: "Málaga" },
    { slug: "benalmadena", nombre: "Benalmádena" },
    { slug: "torremolinos", nombre: "Torremolinos" },
    { slug: "nerja", nombre: "Nerja" },
  ];

  // Fetch properties to filter later (simulated SSG data passing)
  const STRAPI_URL =
    import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
  let propData = [];
  try {
    const res = await fetch(`${STRAPI_URL}/api/rentals?populate=*&pagination[limit]=100`);
    const json = await res.json();
    propData = json.data || [];
  } catch (e) {
    /* ignore */
  }

  return zones.flatMap((zona) =>
    categories.map((cat) => ({
      params: { slug: zona.slug, categoria: cat.slug },
      props: { zona, categoria: cat, propData },
    })),
  );
}

const { zona, categoria, propData } = Astro.props;

const filteredProps = propData.filter((p: any) => {
  // Primero filtramos por zona
  const pSlug = p.ubicacion?.slug || p.location?.toLowerCase() || "";
  if (!pSlug.includes(zona.slug)) return false;

  // Luego heurística por categoría
  if (categoria.slug === "lujo") return p.price > 150;
  if (categoria.slug === "familias") return (p.detalles?.capacidad || 0) >= 4;
  if (categoria.slug === "playa")
    return p.description?.toLowerCase().includes("playa");

  return true;
});


// Metadatos SEO Específicos (Long Tail)
const seoTitle = `Alquiler ${categoria.seo} en ${zona.nombre} | Costa del Sol`;
const seoDesc = `Descubre nuestra selección exclusiva de ${categoria.nombre.toLowerCase()} en ${zona.nombre}. Precios verificados y reserva directa.`;

---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Inicio", url: "/" },
    { nombre: zona.nombre, url: `/zona/${zona.slug}` },
    { nombre: categoria.nombre, url: `/zona/${zona.slug}/${categoria.slug}` },
  ]}
>
  <div class="relative z-40 bg-white border-b border-superficie shadow-xs">
    <Breadcrumbs
      items={[
        { label: "Inicio", href: "/" },
        { label: zona.nombre, href: `/zona/${zona.slug}` },
        {
          label: categoria.nombre,
          href: `/zona/${zona.slug}/${categoria.slug}`,
          active: true,
        },
      ]}
      backLink={{ label: "Volver a la zona", href: `/zona/${zona.slug}` }}
    />
  </div>

  <HeroZona nombre={`${zona.nombre} ${categoria.nombre}`} slug={zona.slug} />

  <section class="contenedor-fluido py-16">
    <div class="mb-12 text-center max-w-3xl mx-auto">
      <h2 class="text-3xl font-bold text-primario mb-4">
        {categoria.seo} en {zona.nombre}
      </h2>
      <p class="text-texto-secundario text-lg">
        Hemos seleccionado las mejores propiedades en {zona.nombre} pensando en
        <strong>{categoria.nombre.toLowerCase()}</strong>. Disfruta de la Costa
        del Sol a tu manera.
      </p>
    </div>

    {
      filteredProps.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredProps.map((prop: any) => {
            const p = normalizarRentalStrapi(prop);
            return (
              <FichaAlquiler
                {...p}
                zona={p.zona || zona.nombre}
              />
            );
          })}
        </div>
      ) : (
        <div class="text-center py-20 bg-fondo-claro rounded-3xl border-2 border-dashed border-superficie">
          <p class="text-texto-secundario">
            No encontramos propiedades específicas de tipo "{categoria.nombre}"
            en este momento para {zona.nombre}.
            <br />
            <a
              href={`/zona/${zona.slug}`}
              class="text-secundario underline"
            >
              Ver todas las propiedades en {zona.nombre}
            </a>
          </p>
        </div>
      )
    }
  </section>

  <section class="bg-fondo-claro py-16 text-center">
    <h3 class="text-2xl font-bold text-primario mb-6">
      Explora otras colecciones en {zona.nombre}
    </h3>
    <div class="flex flex-wrap justify-center gap-4">
      {
        ["lujo", "familias", "playa", "golf"].map(
          (c) =>
            c !== categoria.slug && (
              <Boton
                href={`/zona/${zona.slug}/${c}`}
                variante="outline"
                tamano="peque"
              >
                {c.charAt(0).toUpperCase() + c.slice(1)}
              </Boton>
            ),
        )
      }
    </div>
  </section>
</Layout>
