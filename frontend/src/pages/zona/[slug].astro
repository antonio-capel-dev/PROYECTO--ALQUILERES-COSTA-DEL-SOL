---
import Layout from "../../layouts/Layout.astro";
import FichaAlquiler from "../../components/FichaAlquiler.astro";
import Boton from "../../components/ui/Boton.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../components/HeroZona.astro";

import propiedadesLocal from "../../data/propiedades_20.json";

// ‚îÄ‚îÄ 1. GET STATIC PATHS (Build Time) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export async function getStaticPaths() {
  const STRAPI_URL =
    import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

  const normalizarSlug = (txt: string) =>
    txt
      ?.toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "-") || "";

  // Normalizar datos locales para que coincidan con la estructura esperada
  const datosLocalesNormalizados = (propiedadesLocal as any[]).map((p) => ({
    title: p.titulo,
    price: p.precio,
    slug: p.slug,
    ubicacion: {
      nombre: p.zona,
      slug: normalizarSlug(p.zona),
    },
    location: p.zona,
    tipo: p.tipo,
    image: {
      url: p.image_url,
    },
    detalles: {
      habitaciones: p.habitaciones,
      capacidad: p.capacidad,
      banos: p.banos,
      metros: p.metros,
    },
  }));

  let zonas = [];
  let propiedades = [];

  try {
    const res = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
    const data = await res.json();

    if (data.data && data.data.length > 0) {
      propiedades = data.data;
    } else {
      throw new Error("Strapi returned empty data");
    }

    const zonasMap = new Map();

    propiedades.forEach((p: any) => {
      const nombreZona = p.ubicacion?.nombre || p.location || "Costa del Sol";
      const slug = p.ubicacion?.slug || normalizarSlug(nombreZona);

      if (!zonasMap.has(slug)) {
        zonasMap.set(slug, {
          slug,
          nombre: nombreZona,
          imagen: p.image,
        });
      }
    });

    zonas = Array.from(zonasMap.values());
  } catch (error) {
    console.warn("‚ö†Ô∏è Usando datos locales (Fallback):", error);

    // Usar datos locales si Strapi falla
    propiedades = datosLocalesNormalizados;

    // Generar zonas desde datos locales
    const zonasMap = new Map();
    propiedades.forEach((p: any) => {
      const nombreZona = p.location || "Costa del Sol";
      const slug = p.ubicacion?.slug || normalizarSlug(nombreZona);

      if (!zonasMap.has(slug)) {
        zonasMap.set(slug, {
          slug,
          nombre: nombreZona,
          imagen: p.image, // URL directa en local
        });
      }
    });
    zonas = Array.from(zonasMap.values());
  }

  return zonas.map((zona) => {
    const propsDeZona = propiedades.filter((p: any) => {
      const pSlug =
        p.ubicacion?.slug || normalizarSlug(p.ubicacion?.nombre || p.location);
      return pSlug === zona.slug;
    });

    return {
      params: { slug: zona.slug },
      props: { zona, propiedades: propsDeZona },
    };
  });
}

const { zona, propiedades } = Astro.props;

// Fallbacks para propiedades sin foto (Evitar repetici√≥n visual)
const PROPERTY_FALLBACKS = [
  "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=800&q=80",
  "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800&q=80",
  "https://images.unsplash.com/photo-1502005229762-cf1b2da7c5d6?auto=format&fit=crop&w=800&q=80",
  "https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&w=800&q=80",
  "https://images.unsplash.com/photo-1484154218962-a1c002085d2f?auto=format&fit=crop&w=800&q=80",
];

const getPropertyImage = (prop: any, index: number) => {
  if (prop.image?.url) {
    return prop.image.url.startsWith("http")
      ? prop.image.url
      : `${import.meta.env.PUBLIC_STRAPI_URL}${prop.image.url}`;
  }
  return PROPERTY_FALLBACKS[index % PROPERTY_FALLBACKS.length];
};

const seoTitle = `Alquiler Vacacional en ${zona.nombre} | Costa del Sol`;
const seoDesc = `Descubre los mejores apartamentos y villas en ${zona.nombre}. Precios verificados. Reserva directa.`;

// Configuration for Breadcrumbs
const breadcrumbConfig = [
  { label: "Inicio", href: "/" },
  { label: "Zonas", href: "/#zonas" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Inicio", url: "/" },
    { nombre: zona.nombre, url: `/zona/${zona.slug}` },
  ]}
>
  {/* NAVEGACI√ìN Y HERO */}
  <Breadcrumbs
    items={breadcrumbConfig}
    backLink={{ label: "Volver a todas las zonas", href: "/#zonas" }}
  />

  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={propiedades.length}
  />

  {/* LISTADO DE PROPIEDADES */}
  <section class="contenedor-fluido py-16">
    <div
      class="flex items-center justify-between mb-8 border-b border-slate-100 pb-4"
    >
      <h2>Cat√°logo Disponible</h2>
    </div>

    {
      propiedades.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {propiedades.map((prop: any, index: number) => (
            <FichaAlquiler
              titulo={prop.title}
              precio={prop.price}
              habitaciones={prop.detalles?.habitaciones || 2}
              capacidad={prop.detalles?.capacidad || 4}
              image_url={getPropertyImage(prop, index)}
              slug={prop.slug}
              zona={prop.ubicacion?.nombre || prop.location || zona.nombre}
              tipo={prop.tipo}
              puntuacion={4.7}
            />
          ))}
        </div>
      ) : (
        /* EMPTY STATE SOBRESALIENTE */
        <div class="text-center py-20 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
          <div class="animate-bounce mb-4 text-4xl">üèñÔ∏è</div>
          <h3 class="text-xl mb-2">Sin disponibilidad en {zona.nombre}</h3>
          <p class="max-w-md mx-auto mb-8">
            Nuestras propiedades en esta zona se han agotado temporalmente.
          </p>
          <Boton href="/" variante="primario">
            Explorar otras zonas cercanas
          </Boton>
        </div>
      )
    }
  </section>

  {/* INTERLINKING ESTRAT√âGICO SEO (FASE 3) */}
  <section
    class="bg-slate-50 border-t py-16"
    style="border-color: var(--color-borde)"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2
        class="text-2xl font-bold mb-8 text-center"
        style="color: var(--color-texto-principal)"
      >
        Sigue explorando la Costa del Sol
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
        <div
          class="p-6 bg-white rounded-xl shadow-sm border"
          style="border-color: var(--color-borde)"
        >
          <h3
            class="text-lg font-bold mb-3"
            style="color: var(--color-texto-principal)"
          >
            Otras Zonas Destacadas
          </h3>
          <ul class="space-y-4">
            <li>
              <a
                href="/zona/marbella"
                class="text-marca-primaria hover:underline font-medium"
                >Alquiler vacacional en Marbella</a
              >
            </li>
            <li>
              <a
                href="/zona/malaga"
                class="text-marca-primaria hover:underline font-medium"
                >Alquiler vacacional en M√°laga Centro</a
              >
            </li>
            <li>
              <a
                href="/zona/torre-del-mar"
                class="text-marca-primaria hover:underline font-medium"
                >Alquiler vacacional en Torre del Mar</a
              >
            </li>
          </ul>
        </div>

        <div
          class="p-6 bg-white rounded-xl shadow-sm border"
          style="border-color: var(--color-borde)"
        >
          <h3
            class="text-lg font-bold mb-3"
            style="color: var(--color-texto-principal)"
          >
            Cat√°logo Completo
          </h3>
          <p class="mb-4 text-sm" style="color: var(--color-texto-secundario)">
            Descubre toda nuestra oferta de alojamientos verificados a lo largo
            del litoral malague√±o.
          </p>
          <a
            href="/#rentals"
            class="inline-block bg-marca-primaria text-white px-6 py-2 rounded-lg font-medium hover:bg-marca-secundaria transition"
          >
            Ver Alquiler Vacacional Global
          </a>
        </div>

        <div
          class="p-6 bg-white rounded-xl shadow-sm border"
          style="border-color: var(--color-borde)"
        >
          <h3
            class="text-lg font-bold mb-3"
            style="color: var(--color-texto-principal)"
          >
            ¬øNecesitas ayuda?
          </h3>
          <p class="mb-4 text-sm" style="color: var(--color-texto-secundario)">
            Nuestro equipo local te asesora para encontrar la propiedad perfecta
            para tu estancia.
          </p>
          <a
            href="/contacto"
            class="inline-block bg-marca-oscura text-white px-6 py-2 rounded-lg font-medium hover:bg-marca-primaria transition"
          >
            Contactar con asesores
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>
