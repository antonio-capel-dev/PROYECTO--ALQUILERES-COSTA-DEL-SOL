---
import Layout from "../../layouts/Layout.astro";
import FichaAlquiler from "../../components/FichaAlquiler.astro";
import Boton from "../../components/ui/Boton.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../components/HeroZona.astro";
import SeccionFaq from "../../components/SeccionFaq.astro";
import ZoneCard from "../../components/ZoneCard.astro";
import { normalizarRentalStrapi, normalizarRentalLocal } from "../../utils/normalizadores";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { IMAGENES_ZONA, IMAGEN_ZONA_FALLBACK } from "../../config/zonas";
import { fetchPropiedades } from "../../lib/zona/fetchPropiedades";
import { getZonaSlug, getZonaNombre } from "../../lib/zona/getZonaSlug";
import { isInZona } from "../../lib/zona/isInZona";

// 1. GET STATIC PATHS (Build Time)
export async function getStaticPaths() {
  const { data: propiedades, source } = await fetchPropiedades();

  // Construir mapa de zonas a partir de los datos reales (Strapi o local)
  const zonasMap = new Map<string, { slug: string; nombre: string; imagen?: any }>();

  propiedades.forEach((p: any) => {
    const slug = getZonaSlug(p);
    if (!slug) return;
    if (!zonasMap.has(slug)) {
      zonasMap.set(slug, {
        slug,
        nombre: getZonaNombre(p),
        imagen: p.ubicacion?.imagen,
      });
    }
  });

  // Fallback mínimo: si por alguna razón no hay datos
  if (zonasMap.size === 0) {
    ["marbella", "malaga", "benalmadena", "torremolinos", "fuengirola", "nerja"].forEach((s) =>
      zonasMap.set(s, { slug: s, nombre: s.charAt(0).toUpperCase() + s.slice(1) })
    );
  }

  const zonas = Array.from(zonasMap.values());

  return zonas.map((zona) => {
    const propsDeZona = propiedades.filter((p: any) => isInZona(p, zona.slug));
    return {
      params: { slug: zona.slug },
      props: { zona, propiedades: propsDeZona, todasLasZonas: zonas, dataSource: source },
    };
  });
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { zona, propiedades, todasLasZonas } = Astro.props;
const zonaUrl = "/zona/" + zona.slug;

const seoTitle = `Alquiler Vacacional en ${zona.nombre} | Costa del Sol`;
const seoDesc = `Descubre los mejores apartamentos y villas en ${zona.nombre}. Precios verificados. Reserva directa.`;

const ts = (key: any) => t(key).replace('{zone}', zona.nombre);

const breadcrumbConfig = [
  { label: "Inicio", href: "/" },
  { label: "Zonas", href: "/zonas" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];

// Otras zonas: dinámico desde TODAS las zonas generadas (escalable)
const otrasZonas = (todasLasZonas || [])
  .filter((z: any) => z.slug !== zona.slug)
  .slice(0, 3);

const count = propiedades.length;
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Inicio", url: "/" },
    { nombre: zona.nombre, url: zonaUrl },
  ]}
>
  {/* NAVEGACION */}
  <div class="relative z-40 bg-fondo-claro border-b border-superficie">
    <Breadcrumbs
      items={breadcrumbConfig}
      backLink={{ label: t('zone.breadcrumb.back'), href: "/zonas" }}
    />
  </div>

  {/* HERO COMPACTO — banner (28vh) para internas */}
  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={count}
  />

  {/* CONTENIDO SEO — layout 2 columnas en desktop */}
  <section class="contenedor-fluido section-md">
    <div class="layout-sidebar">
      <div class="prose prose-slate prose-lg max-w-none">
        <h2 class="font-bold text-primario mb-6">
          {ts('zone.seo.h2')}
        </h2>
        <p set:html={ts('zone.seo.intro').replace(zona.nombre, `<strong>${zona.nombre}</strong>`)} />

        <h3>{t('zone.seo.beaches.h3')}</h3>
        <p>{ts('zone.seo.beaches.p')}</p>

        <h3>{t('zone.seo.leisure.h3')}</h3>
        <p>{ts('zone.seo.leisure.p')}</p>
      </div>

      {/* Sidebar — info rápida de zona */}
      <aside class="surface p-6 lg:sticky lg:top-24">
        <h4 class="text-lg font-bold text-primario mb-4">{zona.nombre}</h4>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-texto-secundario">Alojamientos</dt>
            <dd class="font-bold text-primario">{count}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-texto-secundario">Tipo</dt>
            <dd class="font-bold text-primario">Vacacional</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-texto-secundario">Costa del Sol</dt>
            <dd class="font-bold text-secundario">Verificado</dd>
          </div>
        </dl>
        <div class="mt-6">
          <Boton href="/contacto" variante="primario" tamano="peque" clase="w-full">
            Consultar disponibilidad
          </Boton>
        </div>
      </aside>
    </div>
  </section>

  {/* LISTADO DE PROPIEDADES */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="flex items-center justify-between mb-8 border-b border-superficie pb-4">
        <h2 class="font-bold text-primario">
          {ts('zone.listings.h2')}
        </h2>
        <span class="text-sm text-texto-secundario font-semibold">
          {count} {count === 1 ? "resultado" : "resultados"}
        </span>
      </div>

      {
        propiedades.length > 0 ? (
          <div class="grid-responsive">
            {propiedades.map((prop: any) => {
              const p = prop.titulo
                ? prop as any
                : normalizarRentalStrapi(prop);
              return (
                <FichaAlquiler
                  slug={p.slug}
                  titulo={p.titulo || p.title}
                  zona={p.zona || zona.nombre}
                  precio={p.precio || p.price}
                  capacidad={p.capacidad || p.detalles?.capacidad || 4}
                  habitaciones={p.habitaciones ?? p.detalles?.habitaciones}
                  image={p.image}
                  image_url={p.image_url}
                />
              );
            })}
          </div>
        ) : (
          <div class="space-y-12">
            {/* Empty state: mensaje + destinos cercanos */}
            <div class="surface text-center py-12 px-6">
              <svg class="w-16 h-16 mx-auto mb-4 text-superficie" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <h3 class="font-bold text-primario mb-2">
                {ts('zone.empty.title')}
              </h3>
              <p class="text-texto-secundario max-w-md mx-auto mb-6">
                {t('zone.empty.desc')}
              </p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <Boton href="/zonas" variante="primario">
                  {t('zone.empty.btn')}
                </Boton>
                <Boton href="/contacto" variante="outline">
                  Contactar
                </Boton>
              </div>
            </div>

            {/* Destinos cercanos — la página nunca queda vacía */}
            <div>
              <h3 class="font-bold text-primario mb-6 text-center">
                Descubre otros destinos en Costa del Sol
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {
                  otrasZonas.map((z: any) => (
                    <ZoneCard
                      nombre={z.nombre}
                      slug={z.slug}
                      imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
                    />
                  ))
                }
              </div>
            </div>
          </div>
        )
      }
    </div>
  </section>

  {/* FAQs CON SCHEMA (Structured Data) */}
  <SeccionFaq pagina="zona" />

  {/* INTERNAL LINKING — solo si hay propiedades (evita duplicar con empty state) */}
  {
    propiedades.length > 0 && (
      <section class="section-md border-t border-superficie">
        <div class="contenedor-fluido">
          <h3 class="font-bold text-primario mb-8 text-center">
            {t('zone.others.h3')}
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {
              otrasZonas.map((z: any) => (
                <ZoneCard
                  nombre={z.nombre}
                  slug={z.slug}
                  imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
                />
              ))
            }
          </div>
        </div>
      </section>
    )
  }
</Layout>
