---
import Layout from "../../layouts/Layout.astro";
import FichaAlquiler from "../../components/FichaAlquiler.astro";
import Boton from "../../components/ui/Boton.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../components/HeroZona.astro";
import SeccionFaq from "../../components/SeccionFaq.astro";
import ZoneCard from "../../components/ZoneCard.astro";
import { normalizarRentalStrapi, normalizarRentalLocal } from "../../utils/normalizadores";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { getContenidoZona } from "../../data/contenidoZonas";
import { IMAGENES_ZONA, IMAGEN_ZONA_FALLBACK } from "../../config/zonas";
import { fetchPropiedades } from "../../lib/zona/fetchPropiedades";
import { buildZonasConPropiedades } from "../../lib/zona/buildZonas";
import { getZonaSlug, getZonaNombre } from "../../lib/zona/getZonaSlug";
import { isInZona } from "../../lib/zona/isInZona";

// 1. GET STATIC PATHS (Build Time) — usa buildZonasConPropiedades (single source)
export async function getStaticPaths() {
  return await buildZonasConPropiedades();
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { zona, propiedades, todasLasZonas } = Astro.props;
const zonaUrl = "/zona/" + zona.slug;

// SEO title/desc defined after count

const ts = (key: any) => t(key).replace('{zone}', zona.nombre);
const contenidoZona = getContenidoZona(zona.slug, zona.nombre);
const faqItems = contenidoZona.faqs;

const breadcrumbConfig = [
  { label: "Inicio", href: "/" },
  { label: "Zonas", href: "/zonas" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];

// Otras zonas: dinámico desde TODAS las zonas generadas (escalable)
const otrasZonas = (todasLasZonas || [])
  .filter((z: any) => z.slug !== zona.slug)
  .slice(0, 3);

const count = propiedades.length;

const seoTitle = `Alquiler en ${zona.nombre} ${new Date().getFullYear()} | Apartamentos y Villas Costa del Sol`;
const seoDesc = `${count > 0 ? count + ' alojamientos verificados' : 'Alojamientos'} en ${zona.nombre}, Costa del Sol. Reserva directa sin comisiones. Mejor precio garantizado.`;
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Inicio", url: "/" },
    { nombre: zona.nombre, url: zonaUrl },
  ]}
>
  {/* NAVEGACION */}
  <div class="relative z-40 bg-fondo-claro border-b border-superficie">
    <Breadcrumbs
      items={breadcrumbConfig}
      backLink={{ label: t('zone.breadcrumb.back'), href: "/zonas" }}
    />
  </div>

  {/* HERO COMPACTO — banner (28vh) para internas */}
  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={count}
  />

  {/* STATS BAND */}
  <div class="bg-primario text-white">
    <div class="contenedor-fluido py-5">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-secundario/20 flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <span class="font-bold text-lg">{zona.nombre}</span>
          <span class="hidden sm:inline text-white/40">|</span>
          <span class="hidden sm:inline text-white/70 text-sm">Costa del Sol</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-center">
            <div class="text-xl font-bold text-sol">{count}</div>
            <div class="text-xs text-white/60 uppercase tracking-wide">alojamientos</div>
          </div>
          <div class="flex items-center gap-2 bg-secundario/20 rounded-full px-4 py-1.5">
            <div class="w-2 h-2 rounded-full bg-secundario animate-pulse"></div>
            <span class="text-xs font-semibold text-secundario uppercase tracking-wide">Verificado</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* CONTENIDO SEO LARGO -- dinamico por zona */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-10 items-start">
        {/* Columna principal */}
        <div>
          <p class="text-lg text-texto-secundario leading-relaxed mb-10 pl-5 border-l-4 border-sol">{contenidoZona.intro}</p>
          {contenidoZona.secciones.map((seccion: any) => (
            <div class="mb-12">
              <div class="flex items-center gap-3 mb-5 pb-3 border-b-2 border-superficie">
                <div class="w-1 h-7 rounded-full bg-secundario shrink-0"></div>
                <h2 class="font-bold text-primario">{seccion.h2}</h2>
              </div>
              {seccion.parrafos.map((p: string) => (
                <p class="text-texto-secundario leading-relaxed mb-4">{p}</p>
              ))}
              {seccion.subsecciones && seccion.subsecciones.length > 0 && (
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                  {seccion.subsecciones.map((sub: any) => (
                    <div class="bg-white rounded-xl border border-superficie p-5 shadow-sm">
                      <h3 class="font-semibold text-primario mb-2 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-secundario shrink-0"></div>
                        {sub.h3}
                      </h3>
                      <p class="text-sm text-texto-secundario leading-relaxed">{sub.texto}</p>
                    </div>
                  ))}
                </div>
              )}
              {seccion.listaCaracteristicas && seccion.listaCaracteristicas.length > 0 && (
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
                  {seccion.listaCaracteristicas.map((item: string) => (
                    <div class="flex items-start gap-3">
                      <div class="w-5 h-5 rounded-full bg-secundario/10 flex items-center justify-center shrink-0 mt-0.5">
                        <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                      </div>
                      <span class="text-sm text-texto-secundario">{item}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
        <aside class="lg:sticky lg:top-24 space-y-4">
          <div class="bg-primario rounded-2xl p-6 text-white">
            <h4 class="text-lg font-bold mb-1">{zona.nombre}</h4>
            <p class="text-white/60 text-sm mb-6">Costa del Sol | Alquiler vacacional</p>
            <div class="mb-6">
              <div class="bg-white/10 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold text-sol">{count}</div>
                <div class="text-xs text-white/60 mt-0.5">Alojamientos disponibles</div>
              </div>
            </div>
            <ul class="space-y-3 mb-6 text-sm">
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Precios verificados sin sorpresas</span>
              </li>
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Atencion personalizada 24h</span>
              </li>
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Reserva directa sin intermediarios</span>
              </li>
            </ul>
            <Boton href="/contacto" variante="primario" tamano="peque" clase="w-full">
              Consultar disponibilidad
            </Boton>
          </div>
          <div class="border border-superficie rounded-2xl p-5 bg-white">
            <p class="text-sm text-texto-secundario mb-3 font-medium">Buscas algo especifico?</p>
            <Boton href="/propiedades" variante="outline" tamano="peque" clase="w-full">
              Ver todos los alojamientos
            </Boton>
          </div>
        </aside>
      </div>
    </div>
  </section>

  {/* LISTADO DE PROPIEDADES */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="flex items-center justify-between mb-8 border-b border-superficie pb-4">
        <h2 class="font-bold text-primario">
          {ts('zone.listings.h2')}
        </h2>
        <span class="text-sm text-texto-secundario font-semibold">
          {count} {count === 1 ? "resultado" : "resultados"}
        </span>
      </div>

      {
        propiedades.length > 0 ? (
          <div class="grid-responsive">
            {propiedades.map((prop: any) => {
              const p = prop.titulo
                ? prop as any
                : normalizarRentalStrapi(prop);
              return (
                <FichaAlquiler
                  slug={p.slug}
                  titulo={p.titulo || p.title}
                  zona={p.zona || zona.nombre}
                  precio={p.precio || p.price}
                  capacidad={p.capacidad || p.detalles?.capacidad || 4}
                  habitaciones={p.habitaciones ?? p.detalles?.habitaciones}
                  image={p.image}
                  image_url={p.image_url}
                />
              );
            })}
          </div>
        ) : (
          <div class="space-y-12">
            {/* Empty state: mensaje + destinos cercanos */}
            <div class="surface text-center py-12 px-6">
              <svg class="w-16 h-16 mx-auto mb-4 text-superficie" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <h3 class="font-bold text-primario mb-2">
                {ts('zone.empty.title')}
              </h3>
              <p class="text-texto-secundario max-w-md mx-auto mb-6">
                {t('zone.empty.desc')}
              </p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <Boton href="/zonas" variante="primario">
                  {t('zone.empty.btn')}
                </Boton>
                <Boton href="/contacto" variante="outline">
                  Contactar
                </Boton>
              </div>
            </div>

            {/* Destinos cercanos — la página nunca queda vacía */}
            <div>
              <h3 class="font-bold text-primario mb-6 text-center">
                Otros destinos en la Costa del Sol
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {
                  otrasZonas.map((z: any) => (
                    <ZoneCard
                      nombre={z.nombre}
                      slug={z.slug}
                      imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
                    />
                  ))
                }
              </div>
            </div>
          </div>
        )
      }
    </div>
  </section>

  {/* FAQs CON SCHEMA (Structured Data) — inline dinámico por zona */}
  {faqItems.length > 0 && (
    <section class="py-24 bg-fondo-claro">
      <div class="max-w-4xl mx-auto px-6">
        <div class="text-center mb-16">
          <h2 class="font-bold text-primario mb-4">
            Preguntas Frecuentes sobre {zona.nombre}
          </h2>
          <p class="text-texto-secundario text-lg">
            Todo lo que necesitas saber sobre tu proximo alquiler en {zona.nombre}.
          </p>
        </div>
        <div class="space-y-4">
          {faqItems.map((item: any) => (
            <details class="group bg-white rounded-2xl border border-superficie p-6 transition-all duration-300 hover:shadow-md open:shadow-lg">
              <summary class="flex justify-between items-center cursor-pointer list-none font-bold text-lg text-primario">
                <span>{item.pregunta}</span>
                <span class="text-secundario transition-transform duration-300 group-open:rotate-180">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </span>
              </summary>
              <div class="mt-4 text-texto-secundario leading-relaxed">
                <p>{item.respuesta}</p>
              </div>
            </details>
          ))}
        </div>
      </div>
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqItems.map((f: any) => ({
          "@type": "Question",
          name: f.pregunta,
          acceptedAnswer: { "@type": "Answer", text: f.respuesta },
        })),
      })} />
    </section>
  )}

  {/* INTERNAL LINKING — solo si hay propiedades (evita duplicar con empty state) */}
  {
    propiedades.length > 0 && (
      <section class="section-md border-t border-superficie">
        <div class="contenedor-fluido">
          <h3 class="font-bold text-primario mb-8 text-center">
            {t('zone.others.h3')}
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {
              otrasZonas.map((z: any) => (
                <ZoneCard
                  nombre={z.nombre}
                  slug={z.slug}
                  imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
                />
              ))
            }
          </div>
        </div>
      </section>
    )
  }
</Layout>
