---
import Layout from "../../layouts/Layout.astro";
import FichaAlquiler from "../../components/FichaAlquiler.astro";
import Boton from "../../components/ui/Boton.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../components/HeroZona.astro";
import SeccionFaq from "../../components/SeccionFaq.astro";
import ZoneCard from "../../components/ZoneCard.astro";
import { FALLBACKS_PROPIEDAD, IMAGENES_ZONA } from "../../config/zonas";
import { ZONAS_CONTENIDO, ZONAS_PRINCIPALES } from "../../data/zonas-contenido";
import propiedades20 from "../../data/propiedades_20.json";

// ‚îÄ‚îÄ 1. GET STATIC PATHS (Build Time) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export async function getStaticPaths() {
  const STRAPI_URL =
    import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

  const normalizarSlug = (txt: string) =>
    txt
      ?.toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "-") || "";

  // Zonas m√≠nimas garantizadas ‚Äî siempre se generan aunque Strapi est√© ca√≠do o devuelva datos parciales.
  // Esto evita 404 al navegar desde Home a cualquiera de estas zonas.
  const ZONAS_MINIMAS = [
    { slug: "marbella", nombre: "Marbella" },
    { slug: "malaga", nombre: "M√°laga" },
    { slug: "benalmadena", nombre: "Benalm√°dena" },
    { slug: "torremolinos", nombre: "Torremolinos" },
    { slug: "fuengirola", nombre: "Fuengirola" },
    { slug: "nerja", nombre: "Nerja" },
    { slug: "torre-del-mar", nombre: "Torre del Mar" },
  ];

  let propiedades = [];
  // Inicializamos el mapa con las zonas m√≠nimas para garantizar que siempre existan
  const zonasMap = new Map(ZONAS_MINIMAS.map((z) => [z.slug, z]));

  try {
    const res = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
    const data = await res.json();
    propiedades = data.data || [];

    // Enriquecemos el mapa con los datos reales de Strapi (a√±ade zonas extra o imagen real)
    propiedades.forEach((p: any) => {
      const nombreZona = p.ubicacion?.nombre || p.location || "Costa del Sol";
      const slug = p.ubicacion?.slug || normalizarSlug(nombreZona);

      if (!zonasMap.has(slug)) {
        // Zona nueva no contemplada en ZONAS_MINIMAS ‚Üí la a√±adimos
        zonasMap.set(slug, {
          slug,
          nombre: nombreZona,
          imagen: p.ubicacion?.imagen ?? undefined,
        });
      } else if (p.ubicacion?.imagen) {
        // Zona ya existente pero Strapi aporta imagen real ‚Üí actualizamos
        const existing = zonasMap.get(slug);
        zonasMap.set(slug, { ...existing, imagen: p.ubicacion.imagen });
      }
    });
  } catch (error) {
    console.error("‚ùå Error build-time fetching zones:", error);
    // zonasMap ya contiene ZONAS_MINIMAS ‚Üí se contin√∫a con ellas.
    // Usamos propiedades_20.json como fallback, normalizadas al formato del template.
    propiedades = (propiedades20 as any[]).map((p) => ({
      slug: p.slug,
      title: p.titulo,
      price: p.precio,
      location: p.zona,
      tipo: p.tipo,
      image_url: p.image_url,
      detalles: {
        habitaciones: p.habitaciones,
        capacidad: p.capacidad,
        banos: p.banos,
        metros: p.metros,
      },
    }));
  }

  const zonas = Array.from(zonasMap.values());

  return zonas.map((zona) => {
    const propsDeZona = propiedades.filter((p: any) => {
      // Compatible con Strapi (ubicacion.slug / ubicacion.nombre) y JSON local (location = "Marbella")
      const pSlug =
        p.ubicacion?.slug ||
        normalizarSlug(p.ubicacion?.nombre || p.location || "");
      return pSlug === zona.slug;
    });

    return {
      params: { slug: zona.slug },
      props: { zona, propiedades: propsDeZona },
    };
  });
}

const { zona, propiedades } = Astro.props;

// Funci√≥n de imagen de propiedad ‚Äî compatible con Strapi y con JSON local
const getPropertyImage = (prop: any, index: number): string => {
  if (prop.image?.url) {
    const base = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
    return prop.image.url.startsWith("http") ? prop.image.url : `${base}${prop.image.url}`;
  }
  // JSON local usa image_url como campo de primer nivel
  if (prop.image_url) return prop.image_url;
  return FALLBACKS_PROPIEDAD[index % FALLBACKS_PROPIEDAD.length];
};

// Contenido SEO enriquecido para esta zona (declarado antes de usarlo en seoTitle)
const contenidoZona = ZONAS_CONTENIDO[zona.slug];
const zonaFaqs = contenidoZona?.faqs ?? [];

// Precio m√≠nimo din√°mico de las propiedades de esta zona (para CTR)
const precioMin = propiedades.length > 0
  ? Math.min(...propiedades.map((p: any) => Number(p.price) || 9999).filter((n) => n < 9999))
  : contenidoZona?.precioDesde ?? null;

const seoTitle = precioMin
  ? `Alquiler vacacional en ${zona.nombre} desde ${precioMin}‚Ç¨/noche ‚Äì Apartamentos y villas`
  : `Alquiler vacacional en ${zona.nombre} ‚Äì Apartamentos y villas en la Costa del Sol`;
const seoDesc = `Reserva tu alquiler en ${zona.nombre}: apartamentos, villas y casas con vistas al mar. ${propiedades.length > 0 ? `${propiedades.length} propiedades disponibles. ` : ""}Precios verificados y reserva directa sin intermediarios.`;

// Configuration for Breadcrumbs
const breadcrumbConfig = [
  { label: "Inicio", href: "/" },
  { label: "Zonas", href: "/#zonas" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];

// Otras zonas para el widget de enlazado interno (excluye la actual)
const otrasZonas = ZONAS_PRINCIPALES.filter((z) => z.slug !== zona.slug).slice(0, 5);
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  urlCanonica={`/zona/${zona.slug}`}
  imagen={IMAGENES_ZONA[zona.slug]}
  breadcrumbs={[
    { nombre: "Inicio", url: "/" },
    { nombre: zona.nombre, url: `/zona/${zona.slug}` },
  ]}
  faq={zonaFaqs}
>
  {/* NAVEGACI√ìN Y HERO */}
  <Breadcrumbs
    items={breadcrumbConfig}
    backLink={{ label: "Volver a todas las zonas", href: "/#zonas" }}
  />

  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={propiedades.length}
  />

  {/* LISTADO DE PROPIEDADES */}
  <section class="contenedor-fluido py-16">
    <div
      class="flex items-center justify-between mb-8 border-b border-slate-100 pb-4"
    >
      <h2 class="text-2xl md:text-3xl font-bold text-marca-oscura">
        Cat√°logo Disponible
      </h2>
    </div>

    {
      propiedades.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {propiedades.map((prop: any, index: number) => (
            <FichaAlquiler
              titulo={prop.title}
              precio={prop.price}
              habitaciones={prop.detalles?.habitaciones || 2}
              capacidad={prop.detalles?.capacidad || 4}
              banos={prop.detalles?.banos || 1}
              metros={prop.detalles?.metros}
              image_url={getPropertyImage(prop, index)}
              slug={prop.slug}
              zona={prop.ubicacion?.nombre || prop.location || zona.nombre}
              tipo={prop.tipo}
              puntuacion={4.7}
            />
          ))}
        </div>
      ) : (
        /* EMPTY STATE SOBRESALIENTE */
        <div class="text-center py-20 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
          <div class="animate-bounce mb-4 text-4xl">üèñÔ∏è</div>
          <h3 class="text-xl font-bold text-marca-oscura mb-2">
            Sin disponibilidad en {zona.nombre}
          </h3>
          <p class="text-slate-500 max-w-md mx-auto mb-8">
            Nuestras propiedades en esta zona se han agotado temporalmente.
          </p>
          <Boton href="/" variante="primario">
            Explorar otras zonas cercanas
          </Boton>
        </div>
      )
    }
  </section>

  {/* SECCI√ìN "SOBRE LA ZONA" ‚Äî Contenido SEO enriquecido */}
  {contenidoZona && (
    <section class="bg-white py-20">
      <div class="max-w-4xl mx-auto px-6">
        <h2 class="text-3xl md:text-4xl font-bold text-marca-oscura mb-8">
          Alquiler vacacional en {zona.nombre}: Gu√≠a completa
        </h2>

        <div class="prose prose-slate lg:prose-lg max-w-none text-slate-600">
          <p class="text-lg leading-relaxed mb-6">{contenidoZona.descripcion.intro}</p>
          <p class="leading-relaxed mb-6">{contenidoZona.descripcion.cuerpo}</p>
          <p class="leading-relaxed mb-6">{contenidoZona.descripcion.cierre}</p>

          {contenidoZona.verTambien.length > 0 && (
            <p class="leading-relaxed mb-10 text-slate-500 border-l-4 border-marca-primaria/30 pl-4">
              <strong class="text-slate-600">Ver tambi√©n:</strong>{" "}
              {contenidoZona.verTambien.map((link, i) => (
                <>
                  <a href={link.href} class="text-marca-primaria hover:underline underline-offset-2">{link.texto}</a>
                  {i < contenidoZona.verTambien.length - 1 ? " ¬∑ " : "."}
                </>
              ))}
            </p>
          )}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
          {/* Playas */}
          <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100">
            <h3 class="text-lg font-bold text-marca-oscura mb-4 flex items-center gap-2">
              <span>üèñÔ∏è</span> Playas principales
            </h3>
            <ul class="space-y-2">
              {contenidoZona.datos.playas.map((playa) => (
                <li class="flex items-center gap-2 text-slate-600">
                  <span class="w-1.5 h-1.5 rounded-full bg-marca-primaria flex-shrink-0"></span>
                  {playa}
                </li>
              ))}
            </ul>
          </div>

          {/* Ventajas */}
          <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100">
            <h3 class="text-lg font-bold text-marca-oscura mb-4 flex items-center gap-2">
              <span>‚úÖ</span> Por qu√© elegir {zona.nombre}
            </h3>
            <ul class="space-y-2">
              {contenidoZona.datos.ventajas.map((v) => (
                <li class="flex items-center gap-2 text-slate-600">
                  <span class="w-1.5 h-1.5 rounded-full bg-green-500 flex-shrink-0"></span>
                  {v}
                </li>
              ))}
            </ul>
          </div>
        </div>

        {/* Transporte */}
        <div class="mt-6 bg-blue-50 rounded-2xl p-6 border border-blue-100">
          <h3 class="text-lg font-bold text-marca-oscura mb-2 flex items-center gap-2">
            <span>üöå</span> Transporte y accesos
          </h3>
          <p class="text-slate-600">{contenidoZona.datos.transporte}</p>
        </div>
      </div>
    </section>
  )}

  {/* SECCI√ìN FAQs POR ZONA */}
  {zonaFaqs.length > 0 && (
    <SeccionFaq preguntas={zonaFaqs} />
  )}

  {/* SECCI√ìN "OTRAS ZONAS" ‚Äî Enlazado interno estrat√©gico */}
  {otrasZonas.length > 0 && (
    <section class="bg-slate-50 py-20">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-marca-oscura mb-4">
            Otras zonas de la Costa del Sol
          </h2>
          <p class="text-slate-600 text-lg max-w-2xl mx-auto">
            Explora m√°s destinos y encuentra el alquiler perfecto en el litoral malague√±o.
          </p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
          {otrasZonas.map((otraZona) => (
            <ZoneCard
              nombre={otraZona.nombre}
              slug={otraZona.slug}
              imagen={IMAGENES_ZONA[otraZona.slug]}
              descripcion={`Alquileres en ${otraZona.nombre}`}
            />
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>
