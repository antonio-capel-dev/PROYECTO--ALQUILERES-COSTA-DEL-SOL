---
import Layout from "../../layouts/Layout.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

export async function getStaticPaths() {
  const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

  let guias = [];
  try {
    const res = await fetch(
      `${STRAPI_URL}/api/guias?` +
      `filters[publicada][$eq]=true&` +
      `populate[imagen_portada][fields][0]=url&` +
      `populate[imagen_portada][fields][1]=formats&` +
      `populate[zona_relacionada][fields][0]=nombre&` +
      `populate[zona_relacionada][fields][1]=slug&` +
      `populate[seo][populate]=ogImage&` +
      `locale=es`
    );
    const json = await res.json();
    guias = json.data || [];
  } catch (e) {
    console.error("Error fetching guias for static paths:", e);
  }

  return guias.map((guia: any) => ({
    params: { slug: guia.slug },
    props: { guia },
  }));
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { guia } = Astro.props;

const seoTitle = guia.seo?.metaTitle || guia.titulo || "Guía Costa del Sol";
const seoDescription = guia.seo?.metaDescription || guia.extracto || "Guía completa sobre alquileres en Costa del Sol";
const ogImage = guia.seo?.ogImage?.url || guia.imagen_portada?.url || "/images/og-default.jpg";
---

<Layout
  titulo={seoTitle}
  descripcion={seoDescription}
  imagen={ogImage}
  breadcrumbs={[
    { nombre: "Guías", url: "/guias" },
    { nombre: guia.titulo, url: `/guia/${guia.slug}` },
  ]}
>
  <Breadcrumbs
    items={[
      { label: t("property.breadcrumb.home"), href: "/" },
      { label: "Guías", href: "/guias" },
      { label: guia.titulo, href: Astro.url.pathname, active: true },
    ]}
  />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {guia.imagen_portada && (
      <div class="mb-8 rounded-3xl overflow-hidden">
        <img
          src={guia.imagen_portada.url}
          alt={guia.imagen_portada.alternativeText || guia.titulo}
          class="w-full h-auto"
          loading="eager"
        />
      </div>
    )}

    <h1 class="text-4xl md:text-5xl font-extrabold text-primario mb-6">
      {guia.titulo}
    </h1>

    {guia.extracto && (
      <p class="text-xl text-texto-secundario mb-8 leading-relaxed">
        {guia.extracto}
      </p>
    )}

    <div class="prose prose-slate lg:prose-lg max-w-none">
      <Fragment set:html={guia.contenido} />
    </div>

    {guia.cta_texto && guia.cta_url && (
      <div class="mt-12 bg-primario rounded-3xl p-8 text-center">
        <h2 class="text-2xl font-bold text-white mb-4">{guia.cta_texto}</h2>
        <a
          href={guia.cta_url}
          class="inline-block bg-white text-primario px-8 py-3 rounded-full font-semibold hover:bg-fondo-claro transition-colors"
        >
          Ver propiedades
        </a>
      </div>
    )}
  </article>
</Layout>
