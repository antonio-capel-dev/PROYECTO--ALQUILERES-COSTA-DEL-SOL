---
import Layout from "../../../layouts/Layout.astro";
import FichaAlquiler from "../../../components/FichaAlquiler.astro";
import propiedades20 from "../../../data/propiedades_20.json";
import {
  normalizarRentalStrapi,
  normalizarRentalLocal,
} from "../../../utils/normalizadores";
import { useTranslations } from "../../../i18n/utils";

const t = useTranslations("en");

export async function getStaticPaths({ paginate }) {
  const STRAPI_URL =
    import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

  let allProperties = [];

  try {
    const res = await fetch(
      `${STRAPI_URL}/api/rentals?populate[ubicacion][fields][0]=nombre&populate[ubicacion][fields][1]=slug&populate[image][fields][0]=url&populate[image][fields][1]=formats&populate[detalles]=*&pagination[limit]=100`,
    );
    const json = await res.json();
    const strapiData = json.data || [];

    if (strapiData.length > 0) {
      allProperties = strapiData.map(normalizarRentalStrapi);
    } else {
      allProperties = (propiedades20 as any[]).map(normalizarRentalLocal);
    }
  } catch (error) {
    console.error("Error fetching Strapi for EN pagination:", error);
    allProperties = (propiedades20 as any[]).map(normalizarRentalLocal);
  }

  return paginate(allProperties, { pageSize: 9 });
}

const { page } = Astro.props;
const { data: properties } = page;

const title =
  page.currentPage === 1
    ? `Holiday Rentals Costa del Sol ${new Date().getFullYear()} | All Verified Properties`
    : `Costa del Sol Rentals | Page ${page.currentPage} of ${page.lastPage}`;
const description =
  page.currentPage === 1
    ? `Complete catalogue of apartments and villas on the Costa del Sol. Verified prices, direct booking. ${page.total} properties available.`
    : `Page ${page.currentPage} of ${page.lastPage}. Browse all holiday properties on the Costa del Sol.`;
---

<Layout
  titulo={title}
  descripcion={description}
  urlPrevia={page.url.prev ? `https://alquileres-costadelsol.com${page.url.prev}` : undefined}
  urlSiguiente={page.url.next ? `https://alquileres-costadelsol.com${page.url.next}` : undefined}
>
  <section class="bg-primario py-20 px-6 text-center">
    <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
      Full Catalogue
    </h1>
    <p class="text-fondo-claro/80 text-lg">
      Browse all available options for your next holiday.
    </p>
  </section>

  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 bg-fondo-claro">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {properties.map((prop) => <FichaAlquiler {...prop} />)}
    </div>

    <div class="flex justify-center items-center gap-4 mt-16">
      {page.url.prev ? (
        <a href={page.url.prev} class="px-6 py-3 bg-white border border-superficie rounded-full font-semibold text-primario hover:bg-secundario hover:text-white transition shadow-sm">
          ← Previous
        </a>
      ) : (
        <span class="px-6 py-3 text-fondo-claro/80 border border-superficie rounded-full cursor-not-allowed">← Previous</span>
      )}
      <span class="text-texto-secundario font-medium">Page {page.currentPage} of {page.lastPage}</span>
      {page.url.next ? (
        <a href={page.url.next} class="px-6 py-3 bg-white border border-superficie rounded-full font-semibold text-primario hover:bg-secundario hover:text-white transition shadow-sm">
          Next →
        </a>
      ) : (
        <span class="px-6 py-3 text-fondo-claro/80 border border-superficie rounded-full cursor-not-allowed">Next →</span>
      )}
    </div>
  </section>
</Layout>
