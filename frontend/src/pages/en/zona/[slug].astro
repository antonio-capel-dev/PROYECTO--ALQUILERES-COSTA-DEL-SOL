---
/**
 * /en/zona/[slug] — English version of zone detail pages.
 * Separate HTML generated at build-time → Google indexes in English.
 * Hreflang auto-generated in SeoHead.astro.
 */
import Layout from "../../../layouts/Layout.astro";
import FichaAlquiler from "../../../components/FichaAlquiler.astro";
import Boton from "../../../components/ui/Boton.astro";
import Breadcrumbs from "../../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../../components/HeroZona.astro";
import SeccionFaq from "../../../components/SeccionFaq.astro";
import ZoneCard from "../../../components/ZoneCard.astro";
import { useTranslations } from "../../../i18n/utils";
import { IMAGENES_ZONA, IMAGEN_ZONA_FALLBACK } from "../../../config/zonas";
import { fetchPropiedades } from "../../../lib/zona/fetchPropiedades";
import { getZonaSlug, getZonaNombre } from "../../../lib/zona/getZonaSlug";
import { isInZona } from "../../../lib/zona/isInZona";

const t = useTranslations("en");
const ts = (key: any, zone: string) => t(key).replace('{zone}', zone);

export async function getStaticPaths() {
  const { data: propiedades } = await fetchPropiedades();

  const zonasMap = new Map<string, { slug: string; nombre: string; imagen?: any }>();
  propiedades.forEach((p: any) => {
    const slug = getZonaSlug(p);
    if (!slug) return;
    if (!zonasMap.has(slug)) {
      zonasMap.set(slug, { slug, nombre: getZonaNombre(p), imagen: p.ubicacion?.imagen });
    }
  });

  if (zonasMap.size === 0) {
    ["marbella", "malaga", "benalmadena", "torremolinos", "fuengirola", "nerja"].forEach((s) =>
      zonasMap.set(s, { slug: s, nombre: s.charAt(0).toUpperCase() + s.slice(1) })
    );
  }

  const zonas = Array.from(zonasMap.values());

  return zonas.map((zona) => {
    const propsDeZona = propiedades.filter((p: any) => isInZona(p, zona.slug));
    return { params: { slug: zona.slug }, props: { zona, propiedades: propsDeZona, todasLasZonas: zonas } };
  });
}

const { zona, propiedades, todasLasZonas } = Astro.props;

const seoTitle = `Holiday Rentals in ${zona.nombre} | Costa del Sol`;
const seoDesc = `Discover the best apartments and villas in ${zona.nombre}. Verified prices. Direct booking. No hidden fees.`;

const breadcrumbConfig = [
  { label: "Home", href: "/en" },
  { label: "Destinations", href: "/en/destinations" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];

const otrasZonas = (todasLasZonas || [])
  .filter((z: any) => z.slug !== zona.slug)
  .slice(0, 3);

const count = propiedades.length;
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Home", url: "/en" },
    { nombre: zona.nombre, url: `/en/zona/${zona.slug}` },
  ]}
>
  <div class="relative z-40 bg-fondo-claro border-b border-superficie">
    <Breadcrumbs
      items={breadcrumbConfig}
      backLink={{ label: "Back to destinations", href: "/en/destinations" }}
    />
  </div>

  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={count}
  />

  {/* SEO Rich Content — English */}
  <section class="contenedor-fluido section-md">
    <div class="prose prose-slate prose-lg max-w-none">
      <h2 class="font-bold text-primario mb-6">
        {ts('zone.seo.h2', zona.nombre)}
      </h2>
      <p set:html={ts('zone.seo.intro', zona.nombre).replace(zona.nombre, `<strong>${zona.nombre}</strong>`)} />

      <h3>{t('zone.seo.beaches.h3')}</h3>
      <p>{ts('zone.seo.beaches.p', zona.nombre)}</p>

      <h3>{t('zone.seo.leisure.h3')}</h3>
      <p>{ts('zone.seo.leisure.p', zona.nombre)}</p>
    </div>
  </section>

  {/* Property Listings */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="flex items-center justify-between mb-8 border-b border-superficie pb-4">
        <h2 class="font-bold text-primario">
          {ts('zone.listings.h2', zona.nombre)}
        </h2>
        <span class="text-sm text-texto-secundario font-semibold">
          {count} {count === 1 ? "result" : "results"}
        </span>
      </div>

      {
        propiedades.length > 0 ? (
          <div class="grid-responsive">
            {propiedades.map((prop: any) => {
              return (
                <FichaAlquiler
                  slug={prop.slug}
                  titulo={prop.titulo || prop.title || "Untitled"}
                  zona={prop.zona || prop.ubicacion?.nombre || zona.nombre}
                  precio={prop.precio || prop.price || 0}
                  capacidad={prop.capacidad || prop.detalles?.capacidad || 4}
                  habitaciones={prop.habitaciones ?? prop.detalles?.habitaciones}
                  image={prop.image}
                  image_url={prop.image_url}
                />
              );
            })}
          </div>
        ) : (
          <div class="surface text-center py-12 px-6">
            <h3 class="font-bold text-primario mb-2">
              {ts('zone.empty.title', zona.nombre)}
            </h3>
            <p class="text-texto-secundario max-w-md mx-auto mb-6">
              {t('zone.empty.desc')}
            </p>
            <Boton href="/en/destinations" variante="primario">
              {t('zone.empty.btn')}
            </Boton>
          </div>
        )
      }
    </div>
  </section>

  <SeccionFaq pagina="zona" />

  {/* Internal Linking */}
  <section class="section-md border-t border-superficie">
    <div class="contenedor-fluido">
      <h3 class="font-bold text-primario mb-8 text-center">
        {t('zone.others.h3')}
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          otrasZonas.map((z: any) => (
            <ZoneCard
              nombre={z.nombre}
              slug={z.slug}
              imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
            />
          ))
        }
      </div>
    </div>
  </section>
</Layout>
