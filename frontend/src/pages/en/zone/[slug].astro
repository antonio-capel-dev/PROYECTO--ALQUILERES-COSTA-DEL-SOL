---
/**
 * /en/zone/[slug] — English version of zone detail pages.
 * Separate HTML generated at build-time → Google indexes in English.
 * Hreflang auto-generated in SeoHead.astro.
 */
import Layout from "../../../layouts/Layout.astro";
import FichaAlquiler from "../../../components/FichaAlquiler.astro";
import Boton from "../../../components/ui/Boton.astro";
import Breadcrumbs from "../../../components/ui/Breadcrumbs.astro";
import HeroZona from "../../../components/HeroZona.astro";
import SeccionFaq from "../../../components/SeccionFaq.astro";
import ZoneCard from "../../../components/ZoneCard.astro";
import { useTranslations } from "../../../i18n/utils";
import { buildZonasConPropiedades } from "../../../lib/zona/buildZonas";
import { getContenidoZona } from "../../../data/contenidoZonas";
import { IMAGENES_ZONA, IMAGEN_ZONA_FALLBACK } from "../../../config/zonas";
import { fetchPropiedades } from "../../../lib/zona/fetchPropiedades";
import { getZonaSlug, getZonaNombre } from "../../../lib/zona/getZonaSlug";
import { isInZona } from "../../../lib/zona/isInZona";

const t = useTranslations("en");
const ts = (key: any, zone: string) => t(key).replace('{zone}', zone);

export async function getStaticPaths() {
  return await buildZonasConPropiedades();
}

const { zona, propiedades, todasLasZonas } = Astro.props;

// seoTitle moved below count
// seoDesc moved below count

const breadcrumbConfig = [
  { label: "Home", href: "/en" },
  { label: "Destinations", href: "/en/destinations" },
  { label: zona.nombre, href: Astro.url.pathname, active: true },
];

const otrasZonas = (todasLasZonas || [])
  .filter((z: any) => z.slug !== zona.slug)
  .slice(0, 3);

const count = propiedades.length;

const seoTitle = `${zona.nombre} Holiday Rentals ${new Date().getFullYear()} | Apartments & Villas Costa del Sol`;
const seoDesc = `${count > 0 ? count + ' verified properties' : 'Properties'} in ${zona.nombre}, Costa del Sol. Direct booking with no fees. Best price guaranteed ${new Date().getFullYear()}.`;
const contenidoZona = getContenidoZona(zona.slug, zona.nombre, "en");
const faqItems = contenidoZona.faqs;
---

<Layout
  titulo={seoTitle}
  descripcion={seoDesc}
  breadcrumbs={[
    { nombre: "Home", url: "/en" },
    { nombre: zona.nombre, url: `/en/zone/${zona.slug}` },
  ]}
>
  <div class="relative z-40 bg-fondo-claro border-b border-superficie">
    <Breadcrumbs
      items={breadcrumbConfig}
      backLink={{ label: "Back to destinations", href: "/en/destinations" }}
    />
  </div>

  <HeroZona
    nombre={zona.nombre}
    slug={zona.slug}
    imagen={zona.imagen}
    propiedadesCount={count}
  />

  {/* STATS BAND */}
  <div class="bg-primario text-white">
    <div class="contenedor-fluido py-5">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-secundario/20 flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <span class="font-bold text-lg">{zona.nombre}</span>
          <span class="hidden sm:inline text-white/40">|</span>
          <span class="hidden sm:inline text-white/70 text-sm">Costa del Sol</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-center">
            <div class="text-xl font-bold text-sol">{count}</div>
            <div class="text-xs text-white/60 uppercase tracking-wide">properties</div>
          </div>
          <div class="flex items-center gap-2 bg-secundario/20 rounded-full px-4 py-1.5">
            <div class="w-2 h-2 rounded-full bg-secundario animate-pulse"></div>
            <span class="text-xs font-semibold text-secundario uppercase tracking-wide">Verified</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* SEO Rich Content — English */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-10 items-start">
        <div>
          <p class="text-lg text-texto-secundario leading-relaxed mb-10 pl-5 border-l-4 border-sol">{contenidoZona.intro}</p>
          {contenidoZona.secciones.map((seccion: any) => (
            <div class="mb-12">
              <div class="flex items-center gap-3 mb-5 pb-3 border-b-2 border-superficie">
                <div class="w-1 h-7 rounded-full bg-secundario shrink-0"></div>
                <h2 class="font-bold text-primario">{seccion.h2}</h2>
              </div>
              {seccion.parrafos.map((p: string) => (
                <p class="text-texto-secundario leading-relaxed mb-4">{p}</p>
              ))}
              {seccion.subsecciones && seccion.subsecciones.length > 0 && (
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                  {seccion.subsecciones.map((sub: any) => (
                    <div class="bg-white rounded-xl border border-superficie p-5 shadow-sm">
                      <h3 class="font-semibold text-primario mb-2 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-secundario shrink-0"></div>
                        {sub.h3}
                      </h3>
                      <p class="text-sm text-texto-secundario leading-relaxed">{sub.texto}</p>
                    </div>
                  ))}
                </div>
              )}
              {seccion.listaCaracteristicas && seccion.listaCaracteristicas.length > 0 && (
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
                  {seccion.listaCaracteristicas.map((item: string) => (
                    <div class="flex items-start gap-3">
                      <div class="w-5 h-5 rounded-full bg-secundario/10 flex items-center justify-center shrink-0 mt-0.5">
                        <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                      </div>
                      <span class="text-sm text-texto-secundario">{item}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
        <aside class="lg:sticky lg:top-24 space-y-4">
          <div class="bg-primario rounded-2xl p-6 text-white">
            <h4 class="text-lg font-bold mb-1">{zona.nombre}</h4>
            <p class="text-white/60 text-sm mb-6">Costa del Sol | Holiday rentals</p>
            <div class="mb-6">
              <div class="bg-white/10 rounded-xl p-3 text-center">
                <div class="text-2xl font-bold text-sol">{count}</div>
                <div class="text-xs text-white/60 mt-0.5">Available properties</div>
              </div>
            </div>
            <ul class="space-y-3 mb-6 text-sm">
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Verified prices, no hidden fees</span>
              </li>
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Personal support 24h</span>
              </li>
              <li class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full bg-secundario/30 flex items-center justify-center shrink-0">
                  <svg class="w-3 h-3 text-secundario" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span class="text-white/80">Direct booking, no intermediaries</span>
              </li>
            </ul>
            <Boton href="/en/contact" variante="primario" tamano="peque" clase="w-full">
              Check availability
            </Boton>
          </div>
          <div class="border border-superficie rounded-2xl p-5 bg-white">
            <p class="text-sm text-texto-secundario mb-3 font-medium">Looking for something specific?</p>
            <Boton href="/en/destinations" variante="outline" tamano="peque" clase="w-full">
              View all destinations
            </Boton>
          </div>
        </aside>
      </div>
    </div>
  </section>

  {/* Property Listings */}
  <section class="bg-fondo-claro section-md">
    <div class="contenedor-fluido">
      <div class="flex items-center justify-between mb-8 border-b border-superficie pb-4">
        <h2 class="font-bold text-primario">
          {ts('zone.listings.h2', zona.nombre)}
        </h2>
        <span class="text-sm text-texto-secundario font-semibold">
          {count} {count === 1 ? "result" : "results"}
        </span>
      </div>

      {
        propiedades.length > 0 ? (
          <div class="grid-responsive">
            {propiedades.map((prop: any) => {
              return (
                <FichaAlquiler
                  slug={prop.slug}
                  titulo={prop.titulo || prop.title || "Untitled"}
                  zona={prop.zona || prop.ubicacion?.nombre || zona.nombre}
                  precio={prop.precio || prop.price || 0}
                  capacidad={prop.capacidad || prop.detalles?.capacidad || 4}
                  habitaciones={prop.habitaciones ?? prop.detalles?.habitaciones}
                  image={prop.image}
                  image_url={prop.image_url}
                />
              );
            })}
          </div>
        ) : (
          <div class="surface text-center py-12 px-6">
            <h3 class="font-bold text-primario mb-2">
              {ts('zone.empty.title', zona.nombre)}
            </h3>
            <p class="text-texto-secundario max-w-md mx-auto mb-6">
              {t('zone.empty.desc')}
            </p>
            <Boton href="/en/destinations" variante="primario">
              {t('zone.empty.btn')}
            </Boton>
          </div>
        )
      }
    </div>
  </section>

  {faqItems && faqItems.length > 0 && (
    <section class="section-md bg-fondo-claro">
      <div class="contenedor-fluido max-w-3xl mx-auto">
        <h2 class="font-bold text-primario mb-8 text-center">Frequently Asked Questions</h2>
        <div class="space-y-4">
          {faqItems.map((item: any) => (
            <details class="surface p-5 rounded-xl group">
              <summary class="flex items-center justify-between cursor-pointer font-semibold text-primario list-none">
                {item.pregunta}
                <span class="ml-4 shrink-0 text-secundario group-open:rotate-180 transition-transform">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </span>
              </summary>
              <div class="mt-4 text-texto-secundario leading-relaxed">
                <p>{item.respuesta}</p>
              </div>
            </details>
          ))}
        </div>
      </div>
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqItems.map((f: any) => ({
          "@type": "Question",
          name: f.pregunta,
          acceptedAnswer: { "@type": "Answer", text: f.respuesta },
        })),
      })} />
    </section>
  )}

  {/* Internal Linking */}
  <section class="section-md border-t border-superficie">
    <div class="contenedor-fluido">
      <h3 class="font-bold text-primario mb-8 text-center">
        {t('zone.others.h3')}
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          otrasZonas.map((z: any) => (
            <ZoneCard
              nombre={z.nombre}
              slug={z.slug}
              imagen={IMAGENES_ZONA[z.slug] ?? IMAGEN_ZONA_FALLBACK}
            />
          ))
        }
      </div>
    </div>
  </section>
</Layout>
