---
import Layout from "../layouts/Layout.astro";
import Boton from "../components/ui/Boton.astro";
import FichaAlquiler from "../components/FichaAlquiler.astro";
import ZoneCard from "../components/ZoneCard.astro";
import BarraBusqueda from "../components/BarraBusqueda.astro";
import SeccionInfo from "../components/SeccionInfo.astro";
import SeccionFaq from "../components/SeccionFaq.astro";
import SeccionTestimonios from "../components/SeccionTestimonios.astro";
import propiedades20 from "../data/propiedades_20.json";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// â”€â”€ Tipo unificado â€” Ãºnica fuente de verdad para FichaAlquiler â”€â”€â”€â”€â”€â”€
type Propiedad = {
  slug: string;
  titulo: string;
  zona: string;
  tipo?: string;
  precio: number;
  capacidad: number;
  habitaciones?: number;
  image_url?: string;
};

// â”€â”€ Normalize: Strapi response â†’ formato plano de FichaAlquiler â”€â”€â”€â”€â”€
const normalizarStrapi = (r: any): Propiedad => ({
  slug: r.slug ?? "",
  titulo: r.title ?? "Sin tÃ­tulo",
  zona: r.ubicacion?.ciudad ?? r.location ?? "",
  tipo: r.tipo ?? undefined,
  precio: r.price ?? 0,
  capacidad: r.detalles?.capacidad ?? 0,
  habitaciones: r.detalles?.habitaciones,
  // Preferimos el campo texto image_url (seed); como fallback, la URL del media de Strapi
  image_url:
    r.image_url ??
    (r.image?.url
      ? r.image.url.startsWith("http")
        ? r.image.url
        : `${STRAPI_URL}${r.image.url}`
      : undefined),
});

// â”€â”€ Normalize: JSON local â†’ mismo formato plano â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const normalizarLocal = (p: any): Propiedad => ({
  slug: p.slug,
  titulo: p.titulo,
  zona: p.zona,
  tipo: p.tipo,
  precio: p.precio,
  capacidad: p.capacidad,
  habitaciones: p.habitaciones,
  image_url: p.image_url,
});

// â”€â”€ Fetch Strapi; si falla o devuelve vacÃ­o â†’ JSON local (20 props) â”€
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
let strapiData: any[] = [];
try {
  const res = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
  const json = await res.json();
  strapiData = json.data || [];
} catch {
  // Strapi no disponible â€” se usarÃ¡ el JSON local como fallback
}

const data: Propiedad[] =
  strapiData.length > 0
    ? strapiData.map(normalizarStrapi)
    : (propiedades20 as any[]).map(normalizarLocal);

// â”€â”€ Dataset mÃ­nimo para filtros.js (slug + criterios de filtrado) â”€
// titulo incluido para que mapa.js pueda mostrarlo en el popup
const dataset = data.map(({ slug, zona, precio, capacidad, titulo }) => ({
  slug,
  zona,
  precio,
  capacidad,
  titulo,
}));

const faqs = [
  {
    pregunta: "Â¿Por quÃ© elegir Alquileres Costa del Sol?",
    respuesta:
      "Contamos con mÃ¡s de 15 aÃ±os de experiencia local y todas nuestras propiedades son verificadas presencialmente. Ofrecemos soporte 24/7 y garantÃ­a de pago seguro.",
  },
  {
    pregunta: "Â¿CÃ³mo se realiza el proceso de reserva?",
    respuesta:
      "Es sencillo: eliges tu propiedad, seleccionas las fechas y realizas el pago de reserva. Nosotros nos encargamos de todo el proceso legal y de entregarte las llaves en mano.",
  },
  {
    pregunta: "Â¿QuÃ© servicios estÃ¡n incluidos en el precio?",
    respuesta:
      "Generalmente el precio incluye limpieza final, WiFi de alta velocidad, sÃ¡banas y toallas. Algunos alojamientos incluyen parking y acceso a piscina comunitaria.",
  },
  {
    pregunta: "Â¿Es seguro alquilar con vosotros?",
    respuesta:
      "Absolutamente. Somos una empresa registrada oficialmente en la Junta de AndalucÃ­a. Tu dinero estÃ¡ protegido y solo se libera al propietario tras un check-in exitoso.",
  },
];
---

<Layout
  titulo="Alquiler Vacacional Costa del Sol 2026: +250 Apartamentos Exclusivos âœ“"
  descripcion="Alquila apartamentos y villas en MÃ¡laga, Marbella y BenalmÃ¡dena. GestiÃ³n local profesional con 15 aÃ±os de experiencia. Sin comisiones ocultas. Â¡Reserva ahora!"
  faq={faqs}
>
  <fragment slot="preload">
    <link
      rel="preload"
      href="https://images.unsplash.com/photo-1596400501869-7c458a1f81df?auto=format&fit=crop&w=1920&q=70"
      as="image"
    />
  </fragment>
  <!-- Barra buscador -->
  <section class="relative pt-32 pb-48 px-10 overflow-hidden bg-slate-900">
    <!-- Fondo estÃ¡tico (Imagen UNIFICADA - Req. Usuario) -->
    <div
      class="absolute inset-0 bg-cover bg-center z-0"
      style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80');"
    >
    </div>

    <!-- Overlay oscuro suave (para legibilidad) -->
    <div class="absolute inset-0 bg-black/40 z-10"></div>

    <div class="relative z-10 max-w-5xl mx-auto text-center">
      <div
        class="inline-block mb-4 px-4 py-1.5 rounded-full bg-marca-primaria/10 border border-marca-primaria/20 text-marca-acento text-sm font-semibold tracking-wide uppercase backdrop-blur-sm"
      >
        âœ¨ TU EXPERTO LOCAL EN LA COSTA DEL SOL
      </div>
      <h1
        class="text-5xl md:text-7xl font-extrabold text-white tracking-tight mb-8 leading-tight"
      >
        Alquiler Vacacional en Costa del Sol
        <br />
        <span
          class="text-transparent bg-clip-text bg-linear-to-r from-marca-acento to-marca-secundaria"
          >Tu Ventana al MediterrÃ¡neo</span
        >
      </h1>
      <p
        class="text-xl text-slate-300 max-w-2xl mx-auto mb-10 font-light leading-relaxed"
      >
        Desde Ã¡ticos exclusivos en MÃ¡laga hasta villas escondidas en Nerja. Tu
        historia inolvidable empieza con una llave.
      </p>
    </div>
  </section>

  <!-- Search Bar (Floating) -->
  <BarraBusqueda />

  <!-- Top Destinos: SEO Silos (Linking Strategy) -->
  <section class="py-16 bg-white border-b border-slate-100">
    <div class="max-w-7xl mx-auto px-6">
      <div
        class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6"
      >
        <div>
          <h2 class="text-3xl font-bold text-marca-oscura mb-2">
            {t("destinations.title")}
          </h2>
          <p class="text-slate-500">
            {t("destinations.desc")}
          </p>
        </div>
        <a
          href="/#rentals"
          class="text-marca-primaria font-bold hover:underline flex items-center gap-1"
        >
          {t("destinations.viewAll")} â†’
        </a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {
          (() => {
            // â”€â”€ ESTRATEGIA: Derivar zonas reales de las propiedades (SSG) â”€â”€
            // Evitamos mostrar zonas vacÃ­as o con fotos rotas hardcodeadas.
            const zonasMap = new Map();

            data.forEach((p) => {
              const nombre = p.zona || "Costa del Sol";
              // NormalizaciÃ³n robusta idÃ©ntica a [slug].astro
              const slug = p.zona
                ? p.zona
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/\s+/g, "-")
                : "costa-del-sol";

              if (!zonasMap.has(slug)) {
                zonasMap.set(slug, {
                  nombre,
                  slug,
                  // Usamos la foto de la primera propiedad encontrada como cover
                  img: p.image_url,
                  cantidad: 1,
                });
              } else {
                const z = zonasMap.get(slug);
                z.cantidad++;
              }
            });

            // Zonas Fallback por si Strapi estÃ¡ vacÃ­o (Defensa Oral: "Empty States")
            const zonasFallback = [
              {
                nombre: "MÃ¡laga Centro",
                slug: "malaga",
                img: "https://images.unsplash.com/photo-1570698473651-b2de99bae12f?auto=format&fit=crop&w=400&q=80",
                cantidad: 0,
              },
              {
                nombre: "Marbella",
                slug: "marbella",
                img: "https://images.unsplash.com/photo-1565538563750-2591e8455e98?auto=format&fit=crop&w=400&q=80",
                cantidad: 0,
              },
              {
                nombre: "BenalmÃ¡dena",
                slug: "benalmadena",
                img: "https://images.unsplash.com/photo-1595245842277-c990ee428236?auto=format&fit=crop&w=400&q=80",
                cantidad: 0,
              },
              {
                nombre: "Torre del Mar",
                slug: "torre-del-mar",
                img: "https://images.unsplash.com/photo-1596400501869-7c458a1f81df?auto=format&fit=crop&w=400&q=80",
                cantidad: 0,
              },
            ];

            const listadoZonas =
              zonasMap.size > 0 ? Array.from(zonasMap.values()) : zonasFallback;

            return listadoZonas.map((zona) => (
              <ZoneCard
                nombre={zona.nombre}
                slug={zona.slug}
                imagen={zona.img}
                cantidad={zona.cantidad}
                descripcion="Destino destacado"
              />
            ));
          })()
        }
      </div>
    </div>
  </section>

  <!-- Info Section (Marketing) -->
  <SeccionInfo />

  <!-- Listings Grid -->
  <section
    id="rentals"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 bg-marca-clara"
  >
    <div
      class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6"
    >
      <div>
        <h2 class="text-3xl md:text-4xl font-bold text-marca-oscura">
          {t("listings.title")}
        </h2>
        <p class="text-slate-500 mt-2 text-lg">
          {t("listings.subtitle")}
        </p>
        <p class="text-sm text-marca-primaria font-semibold mt-1">
          <span id="contador-resultados"
            >{data.length}
            {
              data.length === 1
                ? "propiedad encontrada"
                : "propiedades encontradas"
            }</span
          >
        </p>
      </div>
      <a
        href="#"
        class="flex items-center text-marca-primaria font-semibold hover:text-marca-secundaria transition group"
      >
        {t("listings.viewCatalog")}
        <span class="ml-2 transform group-hover:translate-x-1 transition"
          >â†’</span
        >
      </a>
    </div>

    {/* Carrusel horizontal â€” scroll-snap nativo CSS, sin librerÃ­as */}
    <div class="relative">
      {/* Flecha anterior â€” oculta en mÃ³vil (el usuario desliza con el dedo) */}
      <button
        id="btn-prev"
        aria-label="Propiedad anterior"
        class="hidden md:flex absolute left-0 -translate-x-1/2 top-1/2 -translate-y-1/2 z-10
               w-11 h-11 items-center justify-center
               bg-white rounded-full shadow-lg border border-slate-100
               text-marca-oscura text-xl font-bold
               hover:bg-marca-primaria hover:text-white hover:border-marca-primaria
               transition-colors"
      >
        â†
      </button>

      {/* Contenedor scrollable: flex-row + snap en eje X */}
      <div
        id="carrusel-propiedades"
        class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-2"
        style="scrollbar-width: none;"
      >
        {
          data.map((prop) => (
            // data-slug en el WRAPPER â†’ filtros.js oculta el wrapper completo
            // (el article de FichaAlquiler tambiÃ©n lleva data-slug; ambos reciben display:none)
            <div
              data-slug={prop.slug}
              class="flex-none basis-full md:basis-1/2 lg:basis-1/3 snap-start"
            >
              <FichaAlquiler {...prop} />
            </div>
          ))
        }
      </div>

      {/* Flecha siguiente */}
      <button
        id="btn-next"
        aria-label="Propiedad siguiente"
        class="hidden md:flex absolute right-0 translate-x-1/2 top-1/2 -translate-y-1/2 z-10
               w-11 h-11 items-center justify-center
               bg-white rounded-full shadow-lg border border-slate-100
               text-marca-oscura text-xl font-bold
               hover:bg-marca-primaria hover:text-white hover:border-marca-primaria
               transition-colors"
      >
        â†’
      </button>
    </div>

    {/* Empty State RediseÃ±ado */}
    {
      data.length === 0 && (
        <div class="text-center py-32 bg-white rounded-3xl border-2 border-dashed border-slate-200">
          <div class="text-6xl mb-6">ğŸï¸</div>
          <h3 class="text-2xl font-bold text-marca-oscura mb-2">
            No hay propiedades visibles
          </h3>
          <p class="text-slate-500 max-w-md mx-auto mb-8">
            Parece que Strapi no estÃ¡ enviando datos o la colecciÃ³n estÃ¡ vacÃ­a.
            Â¡AÃ±ade tu primer piso en el panel de control!
          </p>
          <Boton href="#" variante="outline">
            Ir al CMS â†’
          </Boton>
        </div>
      )
    }
  </section>

  {/* â”€â”€ Mapa de ubicaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
  {
    /*
      Leaflet CSS â€” <link> en body es HTML5 vÃ¡lido.
      Se coloca aquÃ­ para no tocar Layout.astro (que no tiene slot head).
  */
  }
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  {
    /*
      Leaflet JS â€” is:inline evita que Astro lo procese con Vite.
      Carga SÃNCRONA (bloqueante) â†’ window.L disponible antes de que
      el bundle diferido (type="module") ejecute inicializarMapa().
  */
  }
  <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <section
    aria-label="Mapa de propiedades disponibles"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 bg-marca-clara"
  >
    <h2 class="text-2xl md:text-3xl font-bold text-marca-oscura mb-2">
      {t("map.title")}
    </h2>
    <p class="text-slate-500 mb-6 text-base">
      {t("map.desc")}
    </p>
    <div
      id="mapa-propiedades"
      class="w-full rounded-2xl overflow-hidden border border-slate-200 shadow-sm"
    >
      {/* Leaflet monta el mapa aquÃ­ â€” altura definida en <style> */}
    </div>
  </section>

  <!-- Testimonios de Clientes (Reviews) -->
  <SeccionTestimonios />

  <!-- FAQ Section (Dudas y Confianza) -->
  <SeccionFaq preguntas={faqs} />
</Layout>

{/* Dataset inyectado en build-time â†’ lo leerÃ¡ filtros.js en el navegador */}
<script
  type="application/json"
  id="propiedades-data"
  is:inline
  set:html={JSON.stringify(dataset)}
/>

<script>
  // Astro bundlea y difiere estos mÃ³dulos â†’ DOM garantizado al ejecutar
  import inicializarFiltros from "../scripts/filtros.js";
  import inicializarCarrusel from "../scripts/carrusel.js";
  import inicializarMapa from "../scripts/mapa.js";
  inicializarFiltros();
  inicializarCarrusel();
  inicializarMapa();
</script>

<style>
  /* Oculta la barra de scroll en WebKit (Chrome, Safari, Edge) */
  #carrusel-propiedades::-webkit-scrollbar {
    display: none;
  }

  /* Altura responsiva del mapa Leaflet */
  #mapa-propiedades {
    height: 320px; /* mÃ³vil */
  }
  @media (min-width: 768px) {
    #mapa-propiedades {
      height: 420px; /* tablet / desktop */
    }
  }
</style>
