---
import Layout from "../layouts/Layout.astro";
import Button from "../components/ui/Button.astro";
import RentalCard from "../components/RentalCard.astro";
import SearchBar from "../components/SearchBar.astro";
import InfoSection from "../components/InfoSection.astro";

// 1. Fetch data from Strapi (Backend)
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
let data = [];
try {
  const response = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
  const json = await response.json();
  data = json.data || [];
} catch (error) {
  console.error("Error fetching data from Strapi:", error);
}
---

<Layout
  title="Alquiler Vacacional Costa del Sol 2026: Pisos y Apartamentos | Trato Directo"
  description="¬øBuscas el verano perfecto? Encuentra los mejores alquileres en Marbella, M√°laga y Benalm√°dena. Pisos, Villas y √Åticos desde 60‚Ç¨/noche. ¬°Reserva hoy!"
>
  <!-- Barra buscador -->
  <section class="relative bg-brand-dark pt-32 pb-48 px-6 overflow-hidden">
    <!-- Con gradiente -->
    <div class="absolute inset-0 z-0 opacity-40">
      <div
        class="absolute inset-0 bg-gradient-to-r from-brand-primary to-brand-purple mix-blend-multiply filter blur-3xl opacity-50 animate-pulse"
      >
      </div>
      <div
        class="absolute -top-24 -left-24 w-96 h-96 bg-brand-accent rounded-full mix-blend-multiply filter blur-3xl opacity-30"
      >
      </div>
    </div>

    <div class="relative z-10 max-w-5xl mx-auto text-center">
      <div
        class="inline-block mb-4 px-4 py-1.5 rounded-full bg-brand-primary/10 border border-brand-primary/20 text-brand-accent text-sm font-semibold tracking-wide uppercase backdrop-blur-sm"
      >
        üå¥ Tu Verano Perfecto 2026
      </div>
      <h1
        class="text-5xl md:text-7xl font-extrabold text-white tracking-tight mb-8 leading-tight"
      >
        Alquiler Vacacional en Costa del Sol <br />
        <span
          class="text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-brand-secondary"
          >Tu Ventana al Mediterr√°neo</span
        >
      </h1>
      <p
        class="text-xl text-slate-300 max-w-2xl mx-auto mb-10 font-light leading-relaxed"
      >
        Desde √°ticos de lujo en M√°laga hasta villas escondidas en Nerja. Tu
        historia inolvidable empieza con una llave.
      </p>
    </div>
  </section>

  <!-- Search Bar (Floating) -->
  <SearchBar />

  <!-- Info Section (Marketing) -->
  <InfoSection />

  <!-- Listings Grid -->
  <section
    id="rentals"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 bg-brand-light"
  >
    <div
      class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6"
    >
      <div>
        <h2 class="text-3xl md:text-4xl font-bold text-brand-dark">
          Joyas Disponibles
        </h2>
        <p class="text-slate-500 mt-2 text-lg">
          Selecci√≥n exclusiva para familias espa√±olas y extranjeros
        </p>
      </div>
      <a
        href="#"
        class="flex items-center text-brand-primary font-semibold hover:text-brand-secondary transition group"
      >
        Ver todo el cat√°logo
        <span class="ml-2 transform group-hover:translate-x-1 transition"
          >‚Üí</span
        >
      </a>
    </div>

    {/* Implementaci√≥n Limpia con nuestro Componente */}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
      {
        data.map((rental) => (
          <RentalCard
            {...rental}
            image={
              rental.image?.url
                ? rental.image.url.startsWith("http")
                  ? rental.image.url
                  : `${STRAPI_URL}${rental.image.url}`
                : undefined
            }
          />
        ))
      }
    </div>

    {/* Empty State Redise√±ado */}
    {
      data.length === 0 && (
        <div class="text-center py-32 bg-white rounded-3xl border-2 border-dashed border-slate-200">
          <div class="text-6xl mb-6">üèùÔ∏è</div>
          <h3 class="text-2xl font-bold text-brand-dark mb-2">
            No hay propiedades visibles
          </h3>
          <p class="text-slate-500 max-w-md mx-auto mb-8">
            Parece que Strapi no est√° enviando datos o la colecci√≥n est√° vac√≠a.
            ¬°A√±ade tu primer piso en el panel de control!
          </p>
          <Button href="#" variant="outline">
            Ir al CMS ‚Üí
          </Button>
        </div>
      )
    }
  </section>
</Layout>
