---
import Layout from "../layouts/Layout.astro";
import Button from "../components/ui/Button.astro";
import RentalCard from "../components/RentalCard.astro";
import SearchBar from "../components/SearchBar.astro";
import InfoSection from "../components/InfoSection.astro";
import propiedades20 from "../data/propiedades_20.json";

// â”€â”€ Tipo unificado â€” Ãºnica fuente de verdad para RentalCard â”€â”€â”€â”€â”€â”€
type Propiedad = {
  slug:          string;
  titulo:        string;
  zona:          string;
  tipo?:         string;
  precio:        number;
  capacidad:     number;
  habitaciones?: number;
  image_url?:    string;
};

// â”€â”€ Normalize: Strapi response â†’ formato plano de RentalCard â”€â”€â”€â”€â”€
const normalizarStrapi = (r: any): Propiedad => ({
  slug:         r.slug          ?? '',
  titulo:       r.title         ?? 'Sin tÃ­tulo',
  zona:         r.ubicacion?.ciudad ?? r.location ?? '',
  tipo:         r.tipo          ?? undefined,
  precio:       r.price         ?? 0,
  capacidad:    r.detalles?.capacidad    ?? 0,
  habitaciones: r.detalles?.habitaciones,
  // Preferimos el campo texto image_url (seed); como fallback, la URL del media de Strapi
  image_url:    r.image_url
    ?? (r.image?.url
      ? (r.image.url.startsWith('http') ? r.image.url : `${STRAPI_URL}${r.image.url}`)
      : undefined),
});

// â”€â”€ Normalize: JSON local â†’ mismo formato plano â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const normalizarLocal = (p: any): Propiedad => ({
  slug:         p.slug,
  titulo:       p.titulo,
  zona:         p.zona,
  tipo:         p.tipo,
  precio:       p.precio,
  capacidad:    p.capacidad,
  habitaciones: p.habitaciones,
  image_url:    p.image_url,
});

// â”€â”€ Fetch Strapi; si falla o devuelve vacÃ­o â†’ JSON local (20 props) â”€
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
let strapiData: any[] = [];
try {
  const res  = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
  const json = await res.json();
  strapiData = json.data || [];
} catch {
  // Strapi no disponible â€” se usarÃ¡ el JSON local como fallback
}

const data: Propiedad[] = strapiData.length > 0
  ? strapiData.map(normalizarStrapi)
  : (propiedades20 as any[]).map(normalizarLocal);

// â”€â”€ Dataset mÃ­nimo para filtros.js (slug + criterios de filtrado) â”€
// titulo incluido para que mapa.js pueda mostrarlo en el popup
const dataset = data.map(({ slug, zona, precio, capacidad, titulo }) => ({
  slug, zona, precio, capacidad, titulo,
}));
---

<Layout
  title="Alquiler Vacacional Costa del Sol 2026: Pisos y Apartamentos | Trato Directo"
  description="Â¿Buscas el verano perfecto? Encuentra los mejores alquileres en Marbella, MÃ¡laga y BenalmÃ¡dena. Pisos, Villas y Ãticos desde 60â‚¬/noche. Â¡Reserva hoy!"
>
  <!-- Barra buscador -->
  <section class="relative bg-brand-dark pt-32 pb-48 px-6 overflow-hidden">
    <!-- Slideshow backgrounds â€” capa mÃ¡s baja, absoluta, full-section -->
    <div
      id="hero-bg-a"
      class="absolute inset-0 bg-cover bg-center transition-opacity duration-1000 opacity-100"
    ></div>
    <div
      id="hero-bg-b"
      class="absolute inset-0 bg-cover bg-center transition-opacity duration-1000 opacity-0"
    ></div>

    <!-- Overlay oscuro: garantiza legibilidad del texto sobre cualquier foto -->
    <div class="absolute inset-0 bg-black/45"></div>

    <!-- Con gradiente (encima del overlay, mezcla de color de marca) -->
    <div class="absolute inset-0 z-0 opacity-40">
      <div
        class="absolute inset-0 bg-gradient-to-r from-brand-primary to-brand-purple mix-blend-multiply filter blur-3xl opacity-50 animate-pulse"
      >
      </div>
      <div
        class="absolute -top-24 -left-24 w-96 h-96 bg-brand-accent rounded-full mix-blend-multiply filter blur-3xl opacity-30"
      >
      </div>
    </div>

    <div class="relative z-10 max-w-5xl mx-auto text-center">
      <div
        class="inline-block mb-4 px-4 py-1.5 rounded-full bg-brand-primary/10 border border-brand-primary/20 text-brand-accent text-sm font-semibold tracking-wide uppercase backdrop-blur-sm"
      >
        ğŸŒ´ Tu Verano Perfecto 2026
      </div>
      <h1
        class="text-5xl md:text-7xl font-extrabold text-white tracking-tight mb-8 leading-tight"
      >
        Alquiler Vacacional en Costa del Sol <br />
        <span
          class="text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-brand-secondary"
          >Tu Ventana al MediterrÃ¡neo</span
        >
      </h1>
      <p
        class="text-xl text-slate-300 max-w-2xl mx-auto mb-10 font-light leading-relaxed"
      >
        Desde Ã¡ticos de lujo en MÃ¡laga hasta villas escondidas en Nerja. Tu
        historia inolvidable empieza con una llave.
      </p>
    </div>
  </section>

  <!-- Search Bar (Floating) -->
  <SearchBar />

  <!-- Info Section (Marketing) -->
  <InfoSection />

  <!-- Listings Grid -->
  <section
    id="rentals"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 bg-brand-light"
  >
    <div
      class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6"
    >
      <div>
        <h2 class="text-3xl md:text-4xl font-bold text-brand-dark">
          Joyas Disponibles
        </h2>
        <p class="text-slate-500 mt-2 text-lg">
          SelecciÃ³n exclusiva para familias espaÃ±olas y extranjeros
        </p>
        <p class="text-sm text-brand-primary font-semibold mt-1">
          <span id="contador-resultados">{data.length} {data.length === 1 ? "propiedad encontrada" : "propiedades encontradas"}</span>
        </p>
      </div>
      <a
        href="#"
        class="flex items-center text-brand-primary font-semibold hover:text-brand-secondary transition group"
      >
        Ver todo el catÃ¡logo
        <span class="ml-2 transform group-hover:translate-x-1 transition"
          >â†’</span
        >
      </a>
    </div>

    {/* Carrusel horizontal â€” scroll-snap nativo CSS, sin librerÃ­as */}
    <div class="relative">

      {/* Flecha anterior â€” oculta en mÃ³vil (el usuario desliza con el dedo) */}
      <button
        id="btn-prev"
        aria-label="Propiedad anterior"
        class="hidden md:flex absolute left-0 -translate-x-1/2 top-1/2 -translate-y-1/2 z-10
               w-11 h-11 items-center justify-center
               bg-white rounded-full shadow-lg border border-slate-100
               text-brand-dark text-xl font-bold
               hover:bg-brand-primary hover:text-white hover:border-brand-primary
               transition-colors"
      >
        â†
      </button>

      {/* Contenedor scrollable: flex-row + snap en eje X */}
      <div
        id="carrusel-propiedades"
        class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-2"
        style="scrollbar-width: none;"
      >
        {data.map((prop) => (
          // data-slug en el WRAPPER â†’ filtros.js oculta el wrapper completo
          // (el article de RentalCard tambiÃ©n lleva data-slug; ambos reciben display:none)
          <div
            data-slug={prop.slug}
            class="flex-none basis-full md:basis-1/2 lg:basis-1/3 snap-start"
          >
            <RentalCard {...prop} />
          </div>
        ))}
      </div>

      {/* Flecha siguiente */}
      <button
        id="btn-next"
        aria-label="Propiedad siguiente"
        class="hidden md:flex absolute right-0 translate-x-1/2 top-1/2 -translate-y-1/2 z-10
               w-11 h-11 items-center justify-center
               bg-white rounded-full shadow-lg border border-slate-100
               text-brand-dark text-xl font-bold
               hover:bg-brand-primary hover:text-white hover:border-brand-primary
               transition-colors"
      >
        â†’
      </button>
    </div>

    {/* Empty State RediseÃ±ado */}
    {
      data.length === 0 && (
        <div class="text-center py-32 bg-white rounded-3xl border-2 border-dashed border-slate-200">
          <div class="text-6xl mb-6">ğŸï¸</div>
          <h3 class="text-2xl font-bold text-brand-dark mb-2">
            No hay propiedades visibles
          </h3>
          <p class="text-slate-500 max-w-md mx-auto mb-8">
            Parece que Strapi no estÃ¡ enviando datos o la colecciÃ³n estÃ¡ vacÃ­a.
            Â¡AÃ±ade tu primer piso en el panel de control!
          </p>
          <Button href="#" variant="outline">
            Ir al CMS â†’
          </Button>
        </div>
      )
    }
  </section>

  {/* â”€â”€ Mapa de ubicaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
  {/*
      Leaflet CSS â€” <link> en body es HTML5 vÃ¡lido.
      Se coloca aquÃ­ para no tocar Layout.astro (que no tiene slot head).
  */}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  {/*
      Leaflet JS â€” is:inline evita que Astro lo procese con Vite.
      Carga SÃNCRONA (bloqueante) â†’ window.L disponible antes de que
      el bundle diferido (type="module") ejecute inicializarMapa().
  */}
  <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <section
    aria-label="Mapa de propiedades disponibles"
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 bg-brand-light"
  >
    <h2 class="text-2xl md:text-3xl font-bold text-brand-dark mb-2">
      Encuentra tu propiedad en el mapa
    </h2>
    <p class="text-slate-500 mb-6 text-base">
      Haz clic en cualquier marcador para ver el precio y acceder a la ficha.
    </p>
    <div
      id="mapa-propiedades"
      class="w-full rounded-2xl overflow-hidden border border-slate-200 shadow-sm"
    >
      {/* Leaflet monta el mapa aquÃ­ â€” altura definida en <style> */}
    </div>
  </section>
</Layout>

{/* Dataset inyectado en build-time â†’ lo leerÃ¡ filtros.js en el navegador */}
<script type="application/json" id="propiedades-data" is:inline set:html={JSON.stringify(dataset)} />

<script>
  // Astro bundlea y difiere estos mÃ³dulos â†’ DOM garantizado al ejecutar
  import inicializarFiltros  from '../scripts/filtros.js';
  import inicializarCarrusel from '../scripts/carrusel.js';
  import inicializarMapa     from '../scripts/mapa.js';
  import initHeroSlideshow   from '../scripts/hero-slideshow.js';
  inicializarFiltros();
  inicializarCarrusel();
  inicializarMapa();
  initHeroSlideshow();
</script>

<style>
  /* Oculta la barra de scroll en WebKit (Chrome, Safari, Edge) */
  #carrusel-propiedades::-webkit-scrollbar {
    display: none;
  }

  /* Altura responsiva del mapa Leaflet */
  #mapa-propiedades {
    height: 320px;          /* mÃ³vil */
  }
  @media (min-width: 768px) {
    #mapa-propiedades {
      height: 420px;        /* tablet / desktop */
    }
  }
</style>
