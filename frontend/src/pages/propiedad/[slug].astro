---
import Layout from "../../layouts/Layout.astro";
import Boton from "../../components/ui/Boton.astro";
import Badge from "../../components/ui/Badge.astro";

interface Rental {
  title: string;
  price: number;
  slug: string;
  metaTitle?: string;
  metaDescription?: string;
  image?: { url: string };
  detalles?: {
    capacidad: number;
    habitaciones?: number;
    banos?: number;
    metros?: number;
  };
  ubicacion?: {
    nombre: string;
    slug: string;
  };
  location?: string;
  Servicios?: {
    wifi?: boolean;
    aire_acondicionado?: boolean;
    parking?: boolean;
    mascotas?: boolean;
  };
  description?: string;
}

/**
 * getStaticPaths(): Astro llama a esta funcion en build-time.
 * Consulta TODAS las propiedades de Strapi y genera una ruta /propiedad/[slug]
 * por cada una. Esto produce HTML estatico con SEO perfecto.
 */
export async function getStaticPaths() {
  const STRAPI_URL =
    import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

  let rentals = [];
  try {
    const res = await fetch(`${STRAPI_URL}/api/rentals?populate=*`);
    const json = await res.json();
    rentals = json.data || [];
  } catch (e) {
    console.error("Error fetching rentals for static paths:", e);
  }

  return rentals.map((rental: Rental) => ({
    params: { slug: rental.slug },
    props: { rental },
  }));
}

const { rental } = Astro.props as { rental: Rental };
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";

const seoTitle =
  rental.metaTitle ||
  `${rental.title} desde ${rental.price}‚Ç¨ | Alquileres Costa del Sol`;
const seoDescription =
  rental.metaDescription ||
  `Reserva ${rental.title} en ${rental.ubicacion?.nombre || "Costa del Sol"}. Alojamiento premium con capacidad para ${detalles?.capacidad || 4} personas. ¬°Mejor precio garantizado!`;

// Imagen: URL absoluta o relativa al Strapi
const imageUrl = rental.image?.url
  ? rental.image.url.startsWith("http")
    ? rental.image.url
    : `${STRAPI_URL}${rental.image.url}`
  : undefined;

// Componentes de Strapi
const detalles = rental.detalles;
const servicios = rental.Servicios;

// Ubicacion
const ubicacion = rental.ubicacion;
---

<Layout
  titulo={seoTitle}
  descripcion={seoDescription}
  imagen={imageUrl}
  breadcrumbs={[
    {
      nombre: ubicacion?.nombre || rental.location || "Costa del Sol",
      url: `/zona/${ubicacion?.slug || ""}`,
    },
    { nombre: rental.title, url: `/propiedad/${rental.slug}` },
  ]}
>
  <!-- Breadcrumb para SEO y navegacion -->
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <ol class="flex items-center gap-2 text-sm text-slate-500">
      <li>
        <a href="/" class="hover:text-marca-primaria transition">Inicio</a>
      </li>
      <li class="text-slate-300">/</li>
      {
        ubicacion && (
          <>
            <li>
              <a
                href={`/zona/${ubicacion.slug}`}
                class="hover:text-marca-primaria transition"
              >
                {ubicacion.nombre}
              </a>
            </li>
            <li class="text-slate-300">/</li>
          </>
        )
      }
      <li class="text-marca-oscura font-medium truncate max-w-xs">
        {rental.title}
      </li>
    </ol>
  </nav>

  <!-- SEO T√âCNICO AVANZADO: Schema.org VacationRental -->
  <fragment slot="head">
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "VacationRental",
        name: rental.title,
        description: seoDescription,
        image: imageUrl ? [imageUrl] : [],
        url: Astro.url.href,
        priceRange: `${rental.price}‚Ç¨`,
        address: {
          "@type": "PostalAddress",
          addressLocality:
            ubicacion?.nombre || rental.location || "Costa del Sol",
          addressRegion: "M√°laga",
          addressCountry: "ES",
        },
        numberOfRooms: detalles?.habitaciones || 1,
        occupancy: {
          "@type": "QuantitativeValue",
          value: detalles?.capacidad || 2,
        },
        amenityFeature: [
          servicios?.wifi
            ? {
                "@type": "LocationFeatureSpecification",
                name: "WiFi",
                value: true,
              }
            : null,
          servicios?.aire_acondicionado
            ? {
                "@type": "LocationFeatureSpecification",
                name: "Air Conditioning",
                value: true,
              }
            : null,
          servicios?.parking
            ? {
                "@type": "LocationFeatureSpecification",
                name: "Parking",
                value: true,
              }
            : null,
        ].filter(Boolean),
      })}
    />
  </fragment>

  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
    <!-- Cabecera: Imagen + Info principal -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
      <!-- Imagen -->
      <div class="relative rounded-3xl overflow-hidden bg-slate-200 aspect-4/3">
        {
          imageUrl ? (
            <img
              src={imageUrl}
              alt={rental.title}
              class="w-full h-full object-cover"
              loading="eager"
            />
          ) : (
            <div class="w-full h-full flex items-center justify-center text-slate-400">
              <span class="text-8xl">üè°</span>
            </div>
          )
        }
        <!-- Precio flotante -->
        <div
          class="absolute top-6 right-6 bg-white/95 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg"
        >
          <span class="text-2xl font-bold text-marca-oscura"
            >{rental.price}‚Ç¨</span
          >
          <span class="text-sm text-slate-500">/ noche</span>
        </div>
      </div>

      <!-- Info principal -->
      <div class="flex flex-col justify-center">
        {
          ubicacion && (
            <Badge variante="acento" clase="mb-4 self-start">
              {ubicacion.nombre}
            </Badge>
          )
        }

        <h1 class="mb-4"
        >
          {rental.title}
        </h1>

        {
          (rental.location || ubicacion) && (
            <p class="flex items-center text-lg mb-8">
              <span class="mr-2 text-marca-acento">üìç</span>
              {rental.location || ubicacion?.nombre || "Costa del Sol"}
            </p>
          )
        }

        <!-- Detalles del inmueble  -->
        {
          detalles && (
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
              {detalles.habitaciones != null && (
                <div class="bg-marca-clara rounded-xl p-4 text-center">
                  <span class="block text-2xl font-bold text-marca-oscura">
                    {detalles.habitaciones}
                  </span>
                  <span class="text-sm text-slate-500">Habitaciones</span>
                </div>
              )}
              {detalles.banos != null && (
                <div class="bg-marca-clara rounded-xl p-4 text-center">
                  <span class="block text-2xl font-bold text-marca-oscura">
                    {detalles.banos}
                  </span>
                  <span class="text-sm text-slate-500">Ba√±os</span>
                </div>
              )}
              {detalles.metros != null && (
                <div class="bg-marca-clara rounded-xl p-4 text-center">
                  <span class="block text-2xl font-bold text-marca-oscura">
                    {detalles.metros}m¬≤
                  </span>
                  <span class="text-sm text-slate-500">Superficie</span>
                </div>
              )}
              {detalles.capacidad != null && (
                <div class="bg-marca-clara rounded-xl p-4 text-center">
                  <span class="block text-2xl font-bold text-marca-oscura">
                    {detalles.capacidad}
                  </span>
                  <span class="text-sm text-slate-500">Hu√©spedes</span>
                </div>
              )}
            </div>
          )
        }

        <!-- Servicios  -->
        {
          servicios && (
            <div class="flex flex-wrap gap-3 mb-10">
              {servicios.wifi && (
                <span class="inline-flex items-center gap-1.5 bg-green-50 text-green-700 px-3 py-1.5 rounded-full text-sm font-medium border border-green-200">
                  WiFi
                </span>
              )}
              {servicios.aire_acondicionado && (
                <span class="inline-flex items-center gap-1.5 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full text-sm font-medium border border-blue-200">
                  Aire Acondicionado
                </span>
              )}
              {servicios.parking && (
                <span class="inline-flex items-center gap-1.5 bg-purple-50 text-purple-700 px-3 py-1.5 rounded-full text-sm font-medium border border-purple-200">
                  Parking
                </span>
              )}
              {servicios.mascotas && (
                <span class="inline-flex items-center gap-1.5 bg-amber-50 text-amber-700 px-3 py-1.5 rounded-full text-sm font-medium border border-amber-200">
                  Mascotas
                </span>
              )}
            </div>
          )
        }

        <div class="flex flex-col sm:flex-row gap-4">
          <Boton href="/contacto" variante="primario" tamano="grande">
            Reservar Ahora
          </Boton>
          <Boton href="/#rentals" variante="outline" tamano="grande">
            Ver m√°s propiedades
          </Boton>
        </div>
      </div>
    </div>

    <!-- Descripcion del inmueble -->
    {
      rental.description && (
        <section class="mb-16">
          <h2 class="mb-6">
            Sobre esta propiedad
          </h2>
          <div class="prose prose-slate lg:prose-lg max-w-none">
            <Fragment set:html={rental.description} />
          </div>
        </section>
      )
    }

    <!-- cta final -->
    <section class="bg-marca-oscura rounded-3xl p-12 text-center">
      <h2 class="mb-4">
        ¬øTe interesa {rental.title}?
      </h2>
      <p class="mb-8 max-w-xl mx-auto">
        Contacta con nuestro equipo local para confirmar disponibilidad y
        reservar sin intermediarios.
      </p>
      <Boton href="/contacto" variante="primario" tamano="grande">
        Contactar Ahora
      </Boton>
    </section>
  </article>
</Layout>
