---
import Boton from "./ui/Boton.astro";
import PropertyImage from "./ui/PropertyImage.astro";
import type { StrapiMedia } from "../utils/imagenes";
import { fallbackPorSlug } from "../config/zonas";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Props {
  slug: string;
  titulo: string;
  zona: string;
  precio: number;
  capacidad: number;
  habitaciones?: number;
  /** Objeto media de Strapi (prioridad máxima) */
  image?: StrapiMedia;
  /** URL texto directa — campo image_url de seed JSON local */
  image_url?: string;
}

const {
  slug,
  titulo,
  zona,
  precio,
  capacidad,
  habitaciones,
  image,
  image_url,
} = Astro.props;

// Fallback determinista: misma propiedad → misma foto aunque cambie el orden.
const fallback = fallbackPorSlug(slug);

// Texto de habitaciones: 0 = estudio, undefined = no mostrar
const textoHab =
  habitaciones === 0
    ? t("card.studio")
    : habitaciones != null
      ? `${habitaciones} ${t("card.rooms")}`
      : null;
---

<article
  class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-superficie/50 overflow-hidden flex flex-col h-full transform hover:-translate-y-1"
  data-slug={slug}
>
  {/* IMAGEN */}
  <div class="relative h-64 bg-superficie overflow-hidden">
    <PropertyImage
      media={image}
      src={image_url}
      fallback={fallback}
      alt={`Alquiler vacacional en ${zona}: ${titulo} — Costa del Sol`}
      width={800}
      height={600}
      loading="lazy"
      preferFormat="medium"
      class="w-full h-full object-cover group-hover:scale-105 transition duration-700 ease-out"
    />

    {/* PRECIO FLOTANTE */}
    <div
      class="absolute top-4 right-4 bg-white/95 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg border border-superficie/50"
    >
      <span class="font-bold text-primario text-lg">{precio}€</span>
      <span class="text-xs text-texto-secundario font-normal">{t("card.night")}</span>
    </div>

  </div>

  {/* CONTENIDO */}
  <div class="p-6 flex flex-col grow">
    <h3
      class="text-xl font-bold text-primario group-hover:text-secundario transition line-clamp-1 mb-2"
    >
      {titulo}
    </h3>

    <div class="flex items-center text-texto-secundario text-sm mb-4 gap-1">
      <svg
        class="w-4 h-4 mr-1 text-acento"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        ></path><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg
      >
      {zona}
    </div>

    {/* DETALLES: habitaciones + capacidad */}
    <div
      class="grid grid-cols-2 gap-2 py-4 mb-4 border-t border-superficie text-sm text-texto-secundario"
    >
      {
        textoHab && (
          <div class="flex flex-col items-center justify-center p-2 bg-fondo-claro rounded-lg">
            {habitaciones === 0 ? (
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1 text-texto-secundario" aria-hidden="true"><path d="M20 9V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3"/><path d="M2 11v5a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v2H6v-2a2 2 0 0 0-4 0Z"/><path d="M4 18v2"/><path d="M20 18v2"/><path d="M12 4v9"/></svg>
            ) : (
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1 text-texto-secundario" aria-hidden="true"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>
            )}
            <span>{textoHab}</span>
          </div>
        )
      }
      <div
        class="flex flex-col items-center justify-center p-2 bg-fondo-claro rounded-lg"
        class:list={[{ "col-span-2": !textoHab }]}
      >
        <svg
          class="w-5 h-5 mx-auto mb-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
          ></path></svg
        >
        <span>{capacidad} {t("card.capacity")}</span>
      </div>
    </div>

    <Boton
      href={`/propiedad/${slug}`}
      variante="outline"
      tamano="peque"
      clase="w-full mt-auto group-hover:bg-secundario group-hover:text-white group-hover:border-secundario transition-colors"
    >
      {t("card.availability")}
    </Boton>
  </div>
</article>
